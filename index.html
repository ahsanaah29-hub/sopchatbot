<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Tally SOP - Sidharth IT Solutions</title>
    <script src="https://cdn.tailwindcss.com">


</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #0052cc;
            --primary-hover: #0041a3;
            --background-color: #f4f7fc;
            --surface-color: #ffffff;
            --text-color: #343a40;
            --text-light: #6c757d;
            --border-color: #dee2e6;
            --header-bg: #0052cc; /* Updated Color */
            --font-family: 'Inter', Arial, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.6;
        }
        /* --- Button Size Modifications --- */
        .btn {
            background-color: var(--primary-color);
            color: white;
            font-size: 13px; /* Smaller font */
            font-weight: 600;
            padding: 8px 12px; /* Reduced padding */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            width: auto;
            text-align: center;
        display: inline-block; min-width: 0; }

        .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        .btn.btn-active {
            background-color: var(--surface-color);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            transform: none;
        }
        .header {
            background-color: var(--header-bg);
            color: white;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            padding: 15px;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid var(--primary-hover);
        }
        .header .logo-title {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            margin-left: 100px;
        }
        .header .logo { font-size: 28px; margin-right: 12px; }
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        .header-btn {
             background-color: var(--primary-color);
            color: white;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 12px; /* Reduced padding */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .header-btn:hover {
            background-color: var(--primary-hover);
        }

        /* New Common Login Page Styles */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            background-color: var(--background-color);
        }
        .login-container {
            display: flex;
            width: 100%;
            max-width: 64rem; /* 1024px */
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .login-info-panel {
            background: linear-gradient(135deg, #003366, #0052cc);
            color: white;
            padding: 3rem;
            width: 45%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .login-info-panel h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .login-info-panel p {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }
        .features-list {
            list-style: none;
            padding: 0;
        }
        .features-list li {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        .features-list .fa-check-circle {
            color: #28a745;
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        .login-form-panel {
            padding: 3rem;
            width: 55%;
        }
        .login-form-panel h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        .login-form-panel p {
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: var(--font-family);
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .error-message { color: #DC3545; font-size: 0.875rem; margin-top: 0.5rem; text-align: center; min-height: 1.25rem; }
        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .admin-container { display: none; }
        .admin-header {
            background-color: #fffbe6;
            color: #856404;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            padding: 15px;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            margin: 0 0 20px 0;
        }

		 /* USER PAGE STYLES */
        .user-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .welcome-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .welcome-message h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }
        .welcome-message p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }
        .user-qa-section {
            background: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .content-header {
            color: var(--header-bg);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
        }
		
		
		
        /* --- Corrected User Page Q&A Layout --- */

.user-qa-layout {
    display: flex;
    gap: 20px; /* Reduced gap for a tighter look */
    align-items: stretch; /* Makes columns have equal height */
    flex-grow: 1;
}

/* Defines the container for the LEFT (Question) column */
.user-question-container {
    flex: 0 0 30%; /* Sets width to 30% */
    background: var(--surface-color);
    padding: 25px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column; /* Stacks content vertically */
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

/* Defines the container for the RIGHT (Answer) column */
.user-answer-container {
    flex: 1 1 70%; /* Takes the remaining 70% of the width */
    background: var(--surface-color);
    padding: 25px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

/* This makes the form group (containing the textarea) grow */
.user-question-container .user-form-group,
.user-answer-container .user-form-group {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

/* This makes the textareas themselves grow to fill the form group */
.user-question-container .user-textarea,
.user-answer-container .user-textarea {
    flex-grow: 1;
    min-height: 300px; /* A reasonable minimum height */
    height: 100%; /* Fill available space */
    border: 1px solid var(--border-color);
    background-color: #fdfdff;
}

/* Standardizes the media buttons for a consistent look */
.user-qa-section .media-btn {
    background: var(--primary-color);
    font-size: 13px;
    padding: 8px 16px;
}
.user-qa-section .media-btn:hover {
    background: var(--primary-hover);
}

		
		
		
		
		/* --- UI Tweaks for Wider Layout & Reduced Spacing --- */

/* 1. Widen the main content container to use more horizontal space */
.user-content {
    max-width: 1400px; /* Increased from 1200px */
}

/* 2. Reduce the space below the 'Your Question' text area */
.submit-section {
    margin-top: 15px; /* Reduced from 20px */
}

/* 3. Reduce the space below the 'Answer' text area */
.media-buttons,
.suggestion-section {
    margin-top: 15px; /* Reduced from 20px */
}




        .user-question-section {
            position: relative;
        }
        .user-answer-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .user-form-group {
            margin-bottom: 20px;
        }
        .user-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 16px;
            color: var(--header-bg);
        }
        .user-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: var(--font-family);
            resize: vertical;
        }
        .user-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .user-answer-area {
            background: white;
            border: 1px solid #e9ecef;
        }
        .user-prediction-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            display: none;
        }
        .user-prediction-item {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        .user-prediction-item:hover {
            background-color: #f8f9fa;
        }
        .user-prediction-item:last-child {
            border-bottom: none;
        }
        .submit-section {
            text-align: center;
            margin-top: 20px;
        }
        
		.submit-btn {
    background: linear-gradient(45deg, var(--primary-color), #0056b3);
    color: white;
    font-size: 16px !important;     /* Increased size and added !important */
    font-weight: 700 !important;     /* Bolder text */
    padding: 12px 30px !important;  /* Increased padding and added !important */
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        .media-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .media-btn {
            background: #28a745;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .media-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        .media-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .media-btn::before {
            font-size: 16px;
        }
        .video-btn::before {
            content: '🎥';
        }
        .image-btn::before {
            content: '🖼️';
        }
        .suggestion-section {
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }
        .suggestion-header {
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }
        .suggestion-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            font-family: var(--font-family);
            resize: vertical;
        }
        .suggestion-btn {
            background: #ffc107;
            color: #212529;
            font-weight: 600;
            margin-top: 10px;
        }
        .suggestion-btn:hover {
            background: #e0a800;
        }
        .media-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .media-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }
        .media-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
		
		
		
		/* --- Corrected, SPECIFIC Header Layout for Q&A --- */
		.content-header.header-with-controls {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
		}

		/* Make the toggle buttons smaller ONLY in this specific header */
		.content-header.header-with-controls .qa-buttons .btn {
			padding: 5px 12px;
			font-size: 12px;
		}
		
		

        .media-modal-close:hover {
            color: #000;
        }
        .admin-content { display: flex; }
        .sidebar {
            width: 220px;
            background-color: var(--surface-color);
            padding: 15px 0;
            border-right: 1px solid var(--border-color);
            min-height: calc(100vh - 70px);
        }
        .menu-item {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            border-left: 3px solid transparent;
        }
        .menu-item:hover { background-color: #f8f9fa; }
        .menu-item.active {
            background-color: #e9f3ff;
            color: var(--primary-color);
            font-weight: 700;
            border-left: 3px solid var(--primary-color);
        }

.main-content {
    flex: 1; /* This is key - it makes the main-content expand to fill remaining space */
    background: var(--background-color);
    padding: 30px;
    overflow-y: auto; /* This creates a single, main scrollbar for the content */
}

        .content-section {
            background: var(--surface-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .hidden { display: none !important; }
        
        /* Custom Department Dropdown Styles */
        .relative { position: relative; }
        .department-dropdown-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            font-family: var(--font-family);
            text-align: left;
            background-color: var(--surface-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .department-dropdown-btn::after {
            content: '▼';
            font-size: 12px;
            color: var(--text-light);
        }
        .department-checkbox-panel {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .department-checkbox-panel label {
            display: flex;
            align-items: left;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            font-weight: 200; /* Reset label font-weight */
        }
        .department-checkbox-panel label:hover { background-color: #f8f9fa; }
        .department-checkbox-panel input[type="checkbox"] { margin-right: 8px; }

        #department-select {
            max-width: 300px;
        }
        .department-checkbox-panel input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* Q&A Layout Width Adjustment */
        .qa-layout-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .question-container, .answer-container {
            flex: 1;
        }

        .question-container {
            flex: 0 0 20%; /* Question takes 20% width */
        }

        .answer-container {
            flex: 1; /* Answer takes remaining 80% width */
        }

        .qa-layout-container .form-group {
            margin-bottom: 0;
        }

        .qa-layout-container textarea {
            height: 400px; /* Fixed height for both textareas */
            resize: vertical;
        }
		
		.question-area, .answer-area {
			border: 1px solid var(--border-color);
			border-radius: 6px;
			padding: 12px;
			background-color: #fdfdff; /* A very light, almost white background */
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.question-area:focus, .answer-area:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.2);
		}

        /* Prediction list positioning for horizontal layout */
        .question-container {
            position: relative;
        }

        .prediction-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .prediction-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .prediction-item:hover {
            background-color: #f8f9fa;
        }

        .prediction-item:last-child {
            border-bottom: none;
        }

        /* Status indicator */
        .status-indicator {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
		
		/* --- Improved Q&A Header Layout --- */
		.content-header.header-with-controls {
			display: flex;              /* Aligns items horizontally */
			justify-content: space-between; /* Pushes title and buttons to opposite ends */
			align-items: center;        /* Vertically centers the items on the line */
			margin-bottom: 20px;        /* Adds space below the header line */
		}

		/* Make the toggle buttons smaller to not overshadow the title */
		.content-header .qa-buttons .btn {
			padding: 5px 12px;
			font-size: 12px;
		}

        @media (max-width: 992px) {
            .login-container { flex-direction: column; }
            .login-info-panel, .login-form-panel { width: 100%; }
        }
        @media (max-width: 768px) {
            .admin-content { flex-direction: column; }
            .sidebar { width: 100%; min-height: auto; border-right: none; border-bottom: 1px solid var(--border-color); }
            .qa-layout-container { flex-direction: column; }
            .question-container, .answer-container { flex: 1; }
            .header .logo-title { margin-left: 0; }
        }
		/* New style for smaller, secondary buttons */
        .btn-secondary {
            background-color: #6c757d; /* A light, neutral gray */
            font-size: 12px;
            padding: 5px 10px;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background-color: #5a6268; /* A slightly darker gray for hover */
        }
        #excel-file {
          font-size: 10px;         /* smaller text */
          padding: 2px 3px;        /* less padding */
          height: 20px;            /* reduce height */
        }

        /* Modal styles for delete confirmation */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            color: #dc3545;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-header::before {
            content: '⚠️';
            font-size: 24px;
        }

        .modal-content {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-content p {
            margin-bottom: 15px;
            color: #343a40;
        }

        .department-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin: 15px 0;
            max-height: 100px;
            overflow-y: auto;
        }

        .department-item {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            color: #dc3545;
        }

        .department-item:last-child {
            border-bottom: none;
        }

        .confirmation-input {
			width: 100%;
			padding: 12px;
			border: 2px solid #dee2e6;
			border-radius: 6px;
			font-size: 16px;
			font-family: var(--font-family);
			margin-top: 10px;
			text-align: center;
			font-weight: 600;
			color: #343a40; /* Add this line to fix the invisible text */
		}

        .confirmation-input:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25);
        }

        .confirmation-input.valid {
            border-color: #28a745;
            background-color: #d4edda;
        }
		

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .modal-btn-cancel {
            background-color: #6c757d;
            color: white;
        }

        .modal-btn-cancel:hover {
            background-color: #5a6268;
        }

        .modal-btn-delete {
            background-color: #dc3545;
            color: white;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-btn-delete.enabled {
            opacity: 1;
            cursor: pointer;
        }

        .modal-btn-delete.enabled:hover {
            background-color: #c82333;
        }

        .confirmation-note {
            font-size: 14px;
            color: #6c757d;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }
		
		.media-management-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }
        .media-control-box {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
        }
		
		.requirements-list {
			list-style: none;
			padding: 0;
			margin: 10px 0;
			font-size: 13px;
			color: #6c757d; /* Muted text color */
		}

		.requirements-list li {
			padding-left: 20px;
			position: relative;
			margin-bottom: 5px;
			transition: color 0.3s ease;
		}

		/* Style for the checkmark before each item */
		.requirements-list li::before {
			content: '○'; /* Default state: empty circle */
			position: absolute;
			left: 0;
			font-weight: bold;
			transition: color 0.3s ease;
		}
		
		.modal .form-group {
			margin-bottom: 1px; /* This controls the spacing inside the modal */
			text-align: left;
		}

		/* Style for a satisfied requirement */
		.requirements-list li.satisfied {
			color: #28a745; /* Green text color */
		}

		.requirements-list li.satisfied::before {
			content: '✓'; /* Checkmark for satisfied state */
			color: #28a745; /* Green checkmark */
		}

        .media-control-box label {
            font-weight: 600;
            display: block;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        .media-filled-state {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .media-icon {
            font-size: 20px;
        }
        .media-link {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-decoration: underline;
            color: #0056b3;
        }
		
		.media-added-feedback {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #28a745; /* Green color for success */
    font-weight: 600;
    font-size: 13px;
    margin-top: 10px;
}
.media-added-feedback .fa-check-circle {
    font-size: 16px;
}

        .btn-link {
            background: none;
            border: none;
            color: #0056b3;
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
            font-size: 12px;
        }
        .btn-link-danger {
            color: #dc3545;
        }

        /* Report Section Styles */
        .report-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .report-tab {
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .report-tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .report-content {
            display: block;
        }

        .report-content.hidden {
            display: none;
        }

        /* Suggestions Table Styles */
        #suggestions-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        #suggestions-table th {
            background-color: var(--header-bg);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        #suggestions-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        #suggestions-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
		
		.password-input-wrapper {
			position: relative;
			display: flex;
			align-items: center;
		}

		.password-input-wrapper .confirmation-input {
			width: 100%;
			padding-right: 40px; /* Make space for the icon */
		}

		.password-toggle-icon {
			position: absolute;
			top: 50%;
			right: 15px;
			transform: translateY(-50%);
			cursor: pointer;
			color: #adb5bd;
			display: none; /* Initially hidden by default */
			transition: all 0.2s ease-in-out; /* Animate color, transform, etc. */
		}

		.password-toggle-icon:hover {
			color: #343a40; /* Darken on hover */
			transform: translateY(-50%) scale(1.2); /* Scale up slightly on hover */
		}

        .status-resolved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .action-btn.resolve {
            background-color: #28a745;
            color: white;
        }

        .action-btn.resolve:hover {
            background-color: #218838;
        }

        .action-btn.resolved {
            background-color: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Responsive table */
        @media (max-width: 768px) {
            #suggestions-table {
                font-size: 14px;
            }
            
            #suggestions-table th,
            #suggestions-table td {
                padding: 8px 4px;
            }
        }
		
		.truncated-answer {
			display: -webkit-box;
			-webkit-line-clamp: 2; /* Limits the text to 2 lines */
			-webkit-box-orient: vertical;
			overflow: hidden;
			text-overflow: ellipsis;
			margin-bottom: 4px; /* Adds a little space above the 'more' link */
		}

		.more-link {
			font-size: 12px;
			font-weight: 600;
			color: var(--primary-color);
			text-decoration: underline;
			cursor: pointer;
		}


        /* Settings Section Styles */
        .settings-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .settings-group {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .settings-group-title {
            color: var(--header-bg);
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }
		
		.btn-uniform {
			min-width: 130px; /* Adjust this value as needed */
			text-align: center;
		}

        .settings-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .settings-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
		
		.btn-uniform {
			min-width: 130px; /* Adjust this value as needed */
			text-align: center;
		}

        .settings-item input[type="text"] {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .settings-help {
            font-size: 13px;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }

        /* Toggle Switch Styles */
        .settings-toggle {
            margin-bottom: 10px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0;
        }

        .toggle-checkbox {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-checkbox:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        .toggle-checkbox:checked + .toggle-slider::before {
            transform: translateX(26px);
        }

        .toggle-text {
            font-weight: 600;
            color: var(--text-color);
        }

        .settings-actions {
            text-align: center;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 30px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            margin-right: 15px;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        /* Change Password Section Styles */
        .section-title {
            color: var(--header-bg);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .form-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .password-strength {
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
		
		.password-hint {
			font-size: 12px;
			color: #6c757d;
			text-align: left;
			margin-top: 5px;
		}

        .strength-weak {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .strength-medium {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .strength-strong {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .password-match {
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .match-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .match-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .new-admin-password-match {
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.2s ease-in-out;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .admin-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        .admin-item:hover {
            background-color: #f8f9fa;
        }

        .admin-item:last-child {
            border-bottom: none;
        }

        .admin-item input[type="checkbox"] {
            margin-right: 12px;
        }

        .admin-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .admin-user-id {
            font-weight: 600;
            color: var(--text-color);
        }

        .admin-created-date {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        .current-admin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
    
/* === UI overrides (2025-08-12) === */
/* 1) Admin > Q&A: ensure the Answer textarea fills the full remaining width */
#qa-section .qa-layout-container { display: flex; gap: 20px; align-items: flex-start; }
#qa-section .question-container { flex: 0 0 20%; }
#qa-section .answer-container { flex: 1 1 auto; }
#qa-section .question-area,
#qa-section .answer-area { width: 100% !important; min-height: 400px; }

/* 2) Make buttons smaller (target the requested ones; fallback to all .btn & variants) */
#qa-section .qa-buttons .btn,                     /* Ask / Add */
#admin-buttons .btn,                              /* Save / Edit & Update */
#admin-buttons .btn.btn-secondary,                /* Import from Excel */
#media-section .btn,                              /* Video / Image in admin */
#department-section #create-dept-btn,             /* Create button in Department */
#department-section #delete-dept-btn,             /* Delete Selected in Department */
#report-section .btn,                             /* Report page buttons */
.btn, .btn-secondary, .media-btn {   /* Fallback: make all buttons small for consistency */
  font-size: 12px !important;
  padding: 6px 10px !important;
  border-radius: 6px !important;
  line-height: 1.2 !important;
}

/* Also shrink file input label/button area for Import Excel line, keep tidy */
#admin-buttons .file-upload label { font-size: 12px; }
#admin-buttons .file-upload input[type="file"] { font-size: 11px; height: 24px; padding: 2px 4px; }

/* Keep header buttons compact too */
.header-btn { font-size: 12px !important; padding: 5px 10px !important; }


/* === Compact button widths (global) === */
button, .btn, .btn-secondary, .submit-btn, .media-btn, .header-btn, .action-btn, .modal-btn, .report-tab {
  width: auto !important;
  display: inline-block !important;
  min-width: 0 !important;
  padding: 6px 10px !important;
  font-size: 12px !important;
  line-height: 1.2 !important;
  border-radius: 6px !important;
}

/* Keep layout containers from forcing full-width buttons */
.form-group .btn,
#admin-buttons .btn,
.report-nav .btn,
.media-buttons .btn,
.media-buttons .media-btn,
.settings-actions .btn,
.qa-buttons .btn,
#dept-left .btn,
#dept-right .btn {
  width: auto !important;
}

/* --- Improved QA Toggle Button Styles --- */

/* The container that groups the buttons */
.qa-buttons {
    display: inline-flex; /* Aligns buttons horizontally and fits their content */
    border-radius: 8px;   /* Rounded corners for the whole component */
    overflow: hidden;     /* Keeps the buttons contained within the rounded corners */
    border: 1px solid var(--primary-color); /* A single border around the group */
}

/* General style for buttons inside the toggle */
.qa-buttons .btn {
    margin: 0;          /* Remove default button margins */
    border: none;       /* Remove default borders */
    border-radius: 0;   /* Buttons are square inside the container */
    background-color: var(--surface-color); /* Default inactive background */
    color: var(--primary-color);
    padding: 8px 16px;  /* Adjust padding for a better look */
    transition: background-color 0.2s ease, color 0.2s ease;
}

/* Add a separator line ONLY between buttons */
.qa-buttons .btn:not(:last-child) {
    border-right: 1px solid var(--primary-color);
}

/* Style for the ACTIVE button */
.qa-buttons .btn.btn-active {
    background-color: var(--primary-color);
    color: white;
}

/* --- UI Tweaks for Q&A Section --- */

/* 1. Adds space between the Ask/Add toggle and the content below it */
.qa-layout-container {
    margin-top: 25px; 
}

/* 2. Makes the active button more prominent and visually distinct */
.qa-buttons .btn.btn-active {
    background-color: var(--primary-color);
    color: white;
    font-weight: 700; /* Makes the text bolder */
    box-shadow: 0 2px 8px rgba(0, 82, 204, 0.3); /* Adds a subtle blue glow */
    transform: translateY(-2px); /* Lifts the button slightly */
}

/* 3. Ensures consistent transition for a smooth effect */
.qa-buttons .btn {
    transition: all 0.2s ease-in-out;
}


/* === Restore normal size for left menu buttons === */
.sidebar button, .sidebar .btn, .menu button, .menu .btn, .nav-link, .menu-item {
  font-size: 14px !important;
  padding: 10px 16px !important;
  line-height: 1.4 !important;
  width: 100% !important;
  display: block !important;
}



/* --- DEFINITIVE FIX for Get Answer Button Size --- */
.submit-section .submit-btn {
    font-size: 16px !important;
    font-weight: 700 !important;
    padding: 12px 30px !important;
}







/* --- Admin Media UI Cleanup & Button Sizing --- */

/* 1. Style the 'Add' buttons for consistency */
.media-control-box .btn-secondary {
    background-color: #6c757d; /* A standard secondary grey */
    color: white;
    font-weight: 500;
}
.media-control-box .btn-secondary:hover {
    background-color: #5a6268;
}

/* 2. Make the main 'Save' button larger and more prominent */
#save-qa-btn {
    font-size: 16px !important;
    font-weight: 700 !important;
    padding: 12px 30px !important;
    min-width: 150px; /* Give it a solid minimum width */
}

/* 3. Improve the alignment and style of the green feedback messages */
.media-added-feedback {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #28a745; /* Green color for success */
    font-weight: 600;
    font-size: 13px;
    margin-top: 12px; /* Standardize margin */
    padding: 8px 12px; /* Add padding */
    background-color: #e9f7ef; /* Add a light green background */
    border-radius: 6px; /* Add rounded corners */
    border: 1px solid #a3d9b3; /* Add a light green border */
}

.media-added-feedback .fa-check-circle {
    font-size: 16px;
}
/* --- Fix for Media Box Alignment --- */
.media-control-box {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}



/* --- Three-column layout for Admin Password & Account Management --- */

/* 1. Redefine the main grid container to support three columns. */
/* We target the div with an inline style for specificity to override it. */
#change-password-section > div[style*="grid"] {
    grid-template-columns: repeat(3, 1fr) !important;
    max-width: 1500px !important; /* Widen the container to fit three cards comfortably. */
    align-items: stretch;           /* Align cards to the top in case of different heights. */
}

/* 2. Use 'display: contents' on the wrapper for the 2nd and 3rd columns. */
/* This makes its children behave as direct grid items of the parent grid. */
#change-password-section .admin-management-section {
    display: contents;
}

/* 3. The title "Admin Account Management" is now redundant and would take up a grid slot. */
/* We hide it to allow the three main cards to align properly. */
#change-password-section .admin-management-section > h3.section-title {
    display: none;
}




/* --- Unify formatting for the three admin management boxes --- */

/* Target the headers for 'Create New Admin' and 'Current Admins' */
#change-password-section .form-card h4 {
    /* Apply the same styles as the main section titles */
    color: var(--header-bg) !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    text-align: center !important;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 10px !important;
    margin: 0 0 20px 0 !important; /* Standardize margin */
}



/* Ensures the bottom border on the 'Current Admins' title spans the full card width */
#change-password-section .form-card > div[style*="justify-content"] > h4 {
    width: 100%;
}



/* --- Clean Layout for Admin Password Section --- */
.admin-grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 30px;
    align-items: stretch; /* This makes all cards the same height */
    max-width: 1500px;
    margin: 0 auto;
}

.admin-card .form-card {
    height: 100%; /* Make the inner box fill the parent card */
    display: flex;
    flex-direction: column;
}



/* Fix table header for scrolling */
#suggestions-table thead tr th {
    position: sticky;
    top: 0;
    z-index: 10; /* Ensures the header is above the scrolling content */
}



#suggestions-table tbody {
    display: block;      /* This is crucial for making the tbody scrollable */
    max-height: 400px; /* Or a reasonable value. You can adjust this to fit your screen */
    overflow-y: auto;
}

#suggestions-table thead,
#suggestions-table tbody tr {
    display: table;     /* These are needed for proper column alignment */
    width: 100%;
    table-layout: fixed; /* Ensures columns have equal widths */
}


.admin-content { 
    display: flex;
    min-height: calc(100vh - 70px); /* 70px is the height of your header */
}


/* --- Q&A Log Table Formatting Fix --- */
#qa-log-table td {
    vertical-align: middle; /* This is the key change for alignment */
}

#qa-log-table .truncated-text {
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Limits text to 2 lines */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal; /* Allows text to wrap */
}


/* Add these styles to your main style block */
#password-reqs-arrow.expanded {
    transform: rotate(180deg);
}
#password-reqs-collapsible .settings-item {
    margin-bottom: 10px;
    padding-bottom: 10px;
}
#password-reqs-collapsible .settings-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}
#chatbot-container {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 1010; /* Ensures it's on top of other elements */
}

#chatbot-bubble {
    width: 50px;
    height: 50px;
    border-radius: 40% !important; /* Forces the button to be a perfect circle */
    background-color: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: transform 0.2s ease;
}

#chatbot-bubble:hover {
    transform: scale(1.1);
}
#chatbot-bubble i {
    font-size: 26px; /* Slightly smaller icon for better padding */
    line-height: 1;
}
#chatbot-bubble svg {
    width: 28px;
    height: 28px;
    fill: white; /* This fills the icon shape with white color */
}
#chatbot-window {
    width: 350px;
    height: 500px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.25);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: absolute;
    bottom: 80px; /* Position above the bubble */
    right: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform-origin: bottom right;
}

#chatbot-window.hidden {
    opacity: 0;
    transform: scale(0.9);
    pointer-events: none; /* Can't interact with it when hidden */
}

.chat-header {
    background-color: var(--primary-color);
    color: white;
    padding: 15px;
    font-weight: 700;
    font-size: 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#close-chat-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    opacity: 0.8;
}
#close-chat-btn:hover {
    opacity: 1;
}

.chat-body {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    background-color: #f4f7fc; /* Light background for chat */
}

.chat-message {
    padding: 10px 15px;
    border-radius: 18px;
    margin-bottom: 10px;
    max-width: 80%;
    line-height: 1.4;
}

.chat-message.bot {
    background-color: #e9ecef; /* Bot message color */
    color: #343a40;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.chat-message.user {
    background-color: var(--primary-color); /* User message color */
    color: white;
    align-self: flex-end;
    margin-left: auto; /* Push to the right */
    border-bottom-right-radius: 4px;
}

.chat-footer {
    display: flex;
    padding: 10px;
    border-top: 1px solid var(--border-color);
}

#chat-input {
    flex-grow: 1;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 14px;
}
#chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

#send-chat-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    font-size: 20px;
    cursor: pointer;
    padding: 0 10px;
}



</style>
</head>
<body>

    <div class="header">
        <div class="logo-title">
            <!---<img class="logo" src="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" alt="Logo" style="height: 24px; width: auto;">
             -->
			 <img class="logo" src=https://files.slack.com/files-pri/T08JP15F1BQ-F0998JF8WAG/untitled_design__2_.jpg>
			<span id="site-title-header">Tally SOP</span>
        </div>
        <div class="header-buttons">
			<!-- User header buttons -->
			<div id="user-header-buttons" style="display:none;">
				<button class="header-btn" id="change-password-btn" onclick="openChangePasswordModal()" style="background-color: #ffc107; color: black;">
					Change Password
				</button>
				<button class="header-btn logout-btn" onclick="logout()">Logout</button>
			</div>

			<!-- Admin header buttons -->
			<div id="admin-header-buttons" style="display:none;">
				<button class="header-btn logout-btn" onclick="logout()">Logout</button>
			</div>
		</div>


		<!-- Change Password Modal -->
		<div id="change-password-modal" class="modal-overlay" style="display: none;">
			<div class="modal">
				<div class="modal-header">
					Change Password
				</div>
				<div class="modal-content">
					<div class="form-group">
						<label for="current-password">Current Password</label>
						<div class="password-input-wrapper">
							<input type="password" id="current-password" class="confirmation-input" placeholder="Enter your current password" autocomplete="current-password" oninput="handlePasswordInput(this)">
							<i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('current-password', this)"></i>
						</div>
					</div>

					<div class="form-group">
						<label for="new-password">New Password</label>
						<div class="password-input-wrapper">
							<input type="password" id="new-password" class="confirmation-input" placeholder="Enter new password" autocomplete="new-password">
							<i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('new-password', this)"></i>
						</div>
					</div>

					<div class="form-group">
						<label for="confirm-new-password">Confirm New Password</label>
						<div class="password-input-wrapper">
							<input type="password" id="confirm-new-password" class="confirmation-input" placeholder="Confirm new password" autocomplete="new-password" oninput="handlePasswordInput(this)">
							<i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('confirm-new-password', this)"></i>
						</div>
					</div>

					<div id="password-requirements">
						<ul class="requirements-list">
							<li id="req-length">At least 8 characters long</li>
							<li id="req-uppercase">At least one uppercase letter (A-Z)</li>
							<li id="req-lowercase">At least one lowercase letter (a-z)</li>
							<li id="req-number">At least one number (0-9)</li>
							<li id="req-special">At least one special character (!@#$%)</li>
						</ul>
					</div>

					<div id="password-match-msg" class="password-feedback"></div>
				</div>
				<div class="modal-buttons">
					<button class="modal-btn modal-btn-cancel" onclick="closeChangePasswordModal()">Cancel</button>
					<button id="confirm-change-password" class="modal-btn btn-primary" onclick="confirmChangePassword()" disabled>
						Save
					</button>
				</div>
			</div>
		</div>
    </div>

    <div id="login-page">
        <div class="login-container">
            <div class="login-info-panel">
                <h1 id="site-title">Ask AroundTally</h1>
                <p>Your comprehensive Tally knowledge base powered by Sidharth IT Solutions</p>
                <ul class="features-list">
                    <li><i class="fas fa-check-circle"></i> Instant access to Tally solutions</li>
                    <li><i class="fas fa-check-circle"></i> Expert-curated content</li>
                    <li><i class="fas fa-check-circle"></i> 24/7 knowledge availability</li>
                    <li><i class="fas fa-check-circle"></i> Professional IT support</li>
                </ul>
            </div>
            <div class="login-form-panel">
                <h2>Welcome Back</h2>
                <p>Please sign in to access your account</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="uid">Username / UID</label>
                        <input type="text" id="uid" name="uid" autocomplete="off" list="user-list-datalist">
                        <datalist id="user-list-datalist"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">Sign In</button>
                    </div>
                    <div id="login-error" class="error-message"></div>
                </form>
                <div class="login-footer">
                    © 2025 Ask AroundTally.com - Powered by Sidharth IT Solutions
                </div>
            </div>
        </div>
    </div>

	 <div id="user-page" class="user-container hidden">
        <div class="user-content">
            <div class="welcome-message">
                <h2>Welcome, <span id="user-name">User</span>!</h2>
                <p>Ask any question about Tally and get instant answers</p>
            </div>
<div class="user-actions" style="text-align: center; margin-bottom: 20px;">
        <button class="btn" id="add-question-btn" onclick="showAddQuestionForm()" style="background: #28a745; margin-right: 10px;">
            📝 Add New Question
        </button>
        <button class="btn" id="back-to-search-btn" onclick="showSearchForm()" style="display: none;">
            🔍 Back to Search
        </button>
    </div>
	 <!-- New Add Question section -->
    <div id="user-add-section" class="user-qa-section" style="display: none;">
        <div class="content-header">Add New Question</div>
        
        <div class="user-qa-layout">
            <div class="user-question-container">
                <div class="user-form-group">
                    <label for="new-user-question">Your Question *</label>
                    <textarea 
                        id="new-user-question" 
                        class="user-textarea" 
                        placeholder="Enter your question here... (Required)"
                        required
                    ></textarea>
                </div>
                
                <div class="user-form-group">
                    <label for="new-user-answer">Your Answer (Optional)</label>
                    <textarea 
                        id="new-user-answer" 
                        class="user-textarea" 
                        placeholder="If you know the answer, you can provide it here..."
                    ></textarea>
                </div>
            </div>

            <div class="user-answer-container">
                <div class="user-form-group">
                    <label>Additional Media (Optional)</label>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="new-user-video">Video URL</label>
                        <input type="url" id="new-user-video" placeholder="Paste video URL here..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="new-user-images">Images/PDF Files</label>
                        <input type="file" id="new-user-images" multiple accept="image/*,.pdf" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">You can select multiple files</div>
                    </div>
                </div>

                <div class="submit-section" style="text-align: center; margin-top: 20px;">
                    <button class="submit-btn" onclick="submitUserQuestion()">
                        Submit for Approval
                    </button>
                    <div style="font-size: 12px; color: #666; margin-top: 10px;">
                        Your question will be reviewed by an admin before being added to the knowledge base.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
            <div class="user-qa-section">
    
    <div class="user-qa-layout">
        <!-- Question Section (Left Side) -->
        <div class="user-question-container">
            <div class="user-form-group" style="position: relative;">
                <label for="user-question">Your Question</label>
                <textarea 
                    id="user-question" 
                    class="user-textarea" 
                    placeholder="Type your question here..."
                    autocomplete="off"
                ></textarea>
                <div id="user-prediction-list" class="user-prediction-list"></div>
            </div>
            
            <div class="submit-section">
                <button class="submit-btn" onclick="handleUserSubmit()">
                    Get Answer
                </button>
            </div>
        </div>

        <!-- Answer Section (Right Side) -->
        <div class="user-answer-container">
            <div class="user-form-group">
                <label for="user-answer">Answer</label>
                <textarea 
                    id="user-answer" 
                    class="user-textarea user-answer-area" 
                    placeholder="Answer will appear here..."
                    readonly
                ></textarea>
            </div>

            <div class="media-buttons" id="user-media-buttons" style="display: none;">
                <button class="media-btn video-btn" id="user-video-btn" onclick="showUserVideo()" disabled>
                    View Video
                </button>
                <button class="media-btn image-btn" id="user-image-btn" onclick="showUserImages()" disabled>
                    View Images
                </button>
            </div>

            <div class="suggestion-section" id="suggestion-section" style="display: none;">
                <div class="suggestion-header">💡 Have a suggestion to improve this answer?</div>
                <textarea 
                    id="suggestion-text" 
                    class="suggestion-textarea" 
                    placeholder="Share your suggestion to help us improve this answer..."
                ></textarea>
                <button class="btn suggestion-btn" onclick="submitSuggestion()">
                    Submit Suggestion
                </button>
            </div>
        </div>
    </div>
	
	
	
</div>

        </div>
    </div>

<div id="admin-page" class="admin-container">
        <div class="admin-content">
            <div class="sidebar">
                <button class="menu-item active" onclick="showSection('qa')">Q and A</button>
                <button class="menu-item" onclick="showSection('department')">User Level Department</button>
                <button class="menu-item" onclick="showSection('user-management')">User Management</button>
                <button class="menu-item" onclick="showSection('report')">Report</button>
                <button class="menu-item" onclick="showSection('settings')">Settings</button>
                <button class="menu-item" onclick="showSection('change-password')">Change Password</button>
            </div>
            
            <div class="main-content">
                <div class="admin-header">Admin Page</div>
                <div id="status-message"></div>
				<div id="pending-suggestions-list" class="hidden"></div>
                
                <div id="qa-section" class="content-section">
                    <div class="content-header header-with-controls">
						<div class="qa-buttons">
							<button class="btn" onclick="setMode('ask')">Ask</button>
							<button class="btn" onclick="setMode('add')">Add</button>
						</div>
						<span class="content-title">Question & Answer Management</span>
<div class="header-placeholder"></div>
</div>
                     
<div class="qa-layout-container">
    <div class="question-container">
        <div class="form-group">
            <label for="admin-question">Question</label>
            <textarea id="admin-question" class="question-area" placeholder="Enter your question here..."></textarea>
            <div id="admin-prediction-list" class="prediction-list" style="display:none;"></div>
        </div>
        
        <!-- Move this AFTER the question field -->
        <div id="add-mode-department-select" class="form-group hidden relative" style="margin-top: 15px;">
            <label for="add-dept-dropdown-btn">Select Department(s)</label>
            <button type="button" id="add-dept-dropdown-btn" class="department-dropdown-btn">All Departments</button>
            <div id="add-department-checkbox" class="department-checkbox-panel hidden">
            </div>
        </div>
    </div>
    
    <div id="department-select" class="form-group hidden relative">
        <label for="dept-dropdown-btn">Select Department(s)</label>
        <button type="button" id="dept-dropdown-btn" class="department-dropdown-btn">Select Departments</button>
        <div id="qa-department-checkbox" class="department-checkbox-panel hidden">
        </div>
    </div>
    
    <div class="answer-container">
        <div class="form-group">
            <label for="admin-answer">Answer</label>
            <textarea id="admin-answer" class="answer-area" placeholder="Answer will appear here..." readonly></textarea>
        </div>
    </div>
</div>
					<div id="ask-mode-media-preview" class="hidden" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <h3 style="margin-bottom: 15px; color: var(--primary-color);">Associated Media</h3>
                        <div id="ask-media-content" style="display: flex; gap: 20px;">
                            </div>
                        <div id="ask-no-media" class="hidden" style="color: #6c757d;">No media is associated with this question.</div>
                    </div>
                    
                    <div id="admin-controls-section" class="hidden" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                        
                        <div class="media-management-grid">
                            <div class="media-control-box">
                                <label>Video</label>
                                <div id="video-filled-state" class="media-filled-state hidden">
                                    <span class="media-icon">🎥</span>
                                    <a id="video-preview-link" href="#" target="_blank" class="media-link">Open Video</a>
                                    <button class="btn-link" onclick="viewMedia('video')">View</button>
                                    <button class="btn-link" onclick="changeMedia('video')">Change</button>
                                    <button class="btn-link btn-link-danger" onclick="removeMedia('video')">Remove</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
									<button class="btn btn-secondary" onclick="addMedia('video')">Add Video</button>
								</div>
                                <input type="text" id="video-url-input" class="hidden" placeholder="Paste video URL here...">
								<div id="video-added-feedback" class="media-added-feedback hidden">
									<i class="fas fa-check-circle"></i> Video URL Added
								</div>
                            </div>

                            <div class="media-control-box">
                                <label>Images / PDF</label>
                                <div id="image-filled-state" class="media-filled-state hidden">
                                    <span class="media-icon">🖼️</span>
                                    <a id="image-preview-link" href="#" target="_blank" class="media-link">View Files</a>
                                    <button class="btn-link" onclick="viewMedia('image')">View</button>
                                    <button class="btn-link" onclick="changeMedia('image')">Change</button>
                                    <button class="btn-link btn-link-danger" onclick="removeMedia('image')">Remove</button>
                                </div>
                                <div id="image-empty-state" class="media-empty-state">
									<button class="btn btn-secondary" onclick="addMedia('image')">Add Image/PDF</button>
								</div>

								<input type="file" id="image-upload-input" style="display: none;" accept="image/*,.pdf" multiple>
                                <div id="image-added-feedback" class="media-added-feedback hidden">
									<i class="fas fa-check-circle"></i> File Selected
								</div>
								<div id="file-preview-area" style="margin-top: 8px;"></div>
								<div id="file-preview-area" style="margin-top: 8px;"></div>
                            </div>
                        </div>

                        <div style="text-align:center; padding: 25px 0; margin-top: 25px;">
							<button id="save-qa-btn" class="btn btn-uniform" onclick="handleSaveOrUpdateQA()">Save</button>
						</div>

						<div style="text-align:center; background-color: #f8f9fa; padding: 20px; border-top: 1px solid #dee2e6; margin-top: 20px;">
							<label for="excel-upload" style="margin-right: 10px; font-weight: 500;">Import from Excel</label>
							<input type="file" id="excel-upload" accept=".xlsx,.xls" class="text-xs p-1 h-7">
							<button class="btn btn-secondary btn-uniform" onclick="importFromExcel()" style="margin-left: 10px;">Import</button>
							<div id="excel-status" style="display:none; font-size:12px; margin-left:8px; margin-top:8px;"></div>
						</div>
                    </div>
                </div>

                <div id="department-section" class="content-section hidden">
                    <div class="content-header">User Level Department</div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items:start;">
                        <div id="dept-left">
                            <div class="form-group">
                                <label for="new-dept-name">Create New Department</label>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="text" id="new-dept-name" placeholder="Enter department name..." style="flex:1;">
                                    <button id="create-dept-btn" class="btn">Create</button>
                                </div>
                                <div id="dept-error" class="error-message" style="display:none;"></div>
                            </div>
                        </div>

                        <div id="dept-right">
                            <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                                <label style="margin:0;">Department List</label>
                                <div>
                                    <button id="delete-dept-btn" class="btn btn-secondary">Delete Selected</button>
                                </div>
                            </div>
                            
                            <div id="dept-success" class="error-message" style="display:none; color:#28a745; font-size:12px; margin-bottom:8px;"></div>

                            <div id="dept-list-box" style="border:1px solid var(--border-color); border-radius:8px; padding:10px; max-height:260px; overflow:auto;">
                                <div id="dept-list-empty" style="color:#666; display:none;">No departments yet.</div>
                                <div id="dept-list" style="display:flex; flex-direction:column; gap:8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="user-management-section" class="content-section hidden">
                    <div class="content-header">User Management</div>
                   <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items:start;">
                        <div id="user-left">
                            <div class="form-group">
                                <label for="new-user-uid">Create New User</label>
                                <input type="text" id="new-user-uid" placeholder="Enter UID..." style="margin-bottom:10px;">
                                
                                <input type="password" id="new-user-password" placeholder="Enter password..." style="margin-bottom:10px;">
                                
                                <div class="relative" style="margin-bottom:10px;">
                                    <button type="button" id="user-dept-dropdown-btn" class="department-dropdown-btn">Select Department</button>
                                    <div id="user-department-checkbox" class="department-checkbox-panel hidden">
                                    </div>
                                </div>
                                
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <button id="create-user-btn" class="btn">Create User</button>
                                </div>
                                <div id="user-error" class="error-message" style="display:none;"></div>
                            </div>
                        </div>

                        <div id="user-right">
                            <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                                <label style="margin:0;">User List</label>
                                <div>
                                    <button id="delete-user-btn" class="btn btn-secondary">Delete Selected</button>
                                </div>
                            </div>
                            
                            <div id="user-success" class="error-message" style="display:none; color:#28a745; font-size:12px; margin-bottom:8px;"></div>

                            <div id="user-list-box" style="border:1px solid var(--border-color); border-radius:8px; padding:10px; max-height:300px; overflow:auto;">
                                <div id="user-list-empty" style="color:#666; display:none;">No users yet.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="report-section" class="content-section hidden">
                    <div class="content-header">Reports</div>
                    
                    <div class="report-nav" style="margin-bottom: 25px;">
                        <button class="btn report-tab active" onclick="showReport('suggestions')">Suggestions Report</button>
                         <button class="btn report-tab" onclick="showReport('user-questions')">User Questions</button>
						 <button class="btn report-tab" onclick="showReport('qa-log')">Q&A Log</button>
                    </div>
<div id="user-questions-report" class="report-content hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: var(--header-bg);">User Submitted Questions</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="user-questions-status-filter" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="read">Mark as Read</option>
                <option value="approved">Approved</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshUserQuestions()">Refresh</button>
        </div>
    </div>

    <div id="user-questions-table-container" style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        <table id="user-questions-table" style="width: 100%; border-collapse: collapse;">
            <thead style="background-color: var(--header-bg); color: white;">
                <tr>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Question</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Answer</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Media</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Submitted By</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Date</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                </tr>
            </thead>
            <tbody id="user-questions-table-body">
            </tbody>
        </table>
        
        <div id="user-questions-empty" style="display: none; text-align: center; padding: 40px; color: #666;">
            <p>No user questions found.</p>
        </div>
    </div>
</div>
     <div id="qa-log-report" class="report-content hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: var(--header-bg);">User Q&A Search Log</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="qa-log-user-filter" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; min-width: 150px;">
                <option value="all">All Users</option>
            </select>
            <input type="date" id="qa-log-date-from" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
            <input type="date" id="qa-log-date-to" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
            <button class="btn btn-secondary" onclick="filterQALog()">Filter</button>
            <button class="btn btn-secondary" onclick="refreshQALog()">Refresh</button>
            <button class="btn btn-secondary" onclick="exportQALog()">Export CSV</button>
        </div>
    </div>

    <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; font-size: 14px;">
        <strong>Total Searches:</strong> <span id="total-searches">0</span> | 
        <strong>Unique Users:</strong> <span id="unique-users">0</span> | 
        <strong>Success Rate:</strong> <span id="success-rate">0%</span>
    </div>

    <div id="qa-log-table-container" style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        <table id="qa-log-table" style="width: 100%; border-collapse: collapse;">
            <thead style="background-color: var(--header-bg); color: white;">
                <tr>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">User ID</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Question Searched</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Answer Found</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Search Time</th>
                </tr>
            </thead>
            <tbody id="qa-log-table-body">
            </tbody>
        </table>
        
        <div id="qa-log-empty" style="display: none; text-align: center; padding: 40px; color: #666;">
            <p>No Q&A log entries found.</p>
        </div>
        
        <div id="qa-log-loading" style="display: none; text-align: center; padding: 40px; color: #666;">
            <p>Loading Q&A log...</p>
        </div>
    </div>

    <div id="qa-log-pagination" style="margin-top: 20px; text-align: center; display: none;">
        <button id="qa-log-prev-page" class="btn btn-secondary" onclick="changeQALogPage(-1)">Previous</button>
        <span id="qa-log-page-info" style="margin: 0 15px; font-weight: 600;"></span>
        <button id="qa-log-next-page" class="btn btn-secondary" onclick="changeQALogPage(1)">Next</button>
    </div>
</div>        
			 <div id="suggestions-report" class="report-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: var(--header-bg);">User Suggestions</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="status-filter" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                                <button class="btn btn-secondary" onclick="refreshSuggestions()">Refresh</button>
                            </div>
                        </div>

                        <div id="suggestions-table-container" style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">

                            <table id="suggestions-table" style="width: 100%; border-collapse: collapse;">
                                <thead style="background-color: var(--header-bg); color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Question</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Answer</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Suggestion</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Created By</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Created Date</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="suggestions-table-body" style="overflow-y: auto;">
                                    </tbody>
                            </table>
                            
                            <div id="suggestions-empty" style="display: none; text-align: center; padding: 40px; color: #666;">
                                <p>No suggestions found.</p>
                            </div>
                            
                            <div id="suggestions-loading" style="display: none; text-align: center; padding: 40px; color: #666;">
                                <p>Loading suggestions...</p>
                            </div>
                        </div>

                        <div id="suggestions-pagination" style="margin-top: 20px; text-align: center; display: none;">
                            <button id="prev-page" class="btn btn-secondary" onclick="changePage(-1)">Previous</button>
                            <span id="page-info" style="margin: 0 15px; font-weight: 600;"></span>
                            <button id="next-page" class="btn btn-secondary" onclick="changePage(1)">Next</button>
                        </div>
                    </div>

                    
                </div>

                <div id="settings-section" class="content-section hidden">
                    <div class="content-header">System Settings</div>
                    
                    <div class="settings-form">
                        <div class="settings-group">
                            <h3 class="settings-group-title">Site Configuration</h3>
                            <div class="settings-item">
                                <label for="current-site-title">Current Site Title</label>
                                <input type="text" id="current-site-title" readonly style="background-color: #f8f9fa; color: #6c757d;">
                                
                                <label for="new-site-title" style="margin-top: 15px;">New Site Title</label>
                                <input type="text" id="new-site-title" placeholder="Enter new site title..." maxlength="100">
                                
                                <button class="btn" onclick="updateSiteTitle()" style="margin-top: 10px;">Update Site Title</button>
                                <div class="settings-help">This will change the site title displayed in the header across the entire application.</div>

                            </div>
                        </div>

                        <div class="settings-group">
                            <h3 class="settings-group-title">User Permissions</h3>
                            
                            <div class="settings-item">
                                <div class="settings-toggle">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="allow-user-list" class="toggle-checkbox">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Show User List in Login</span>
                                    </label>
                                </div>
                                <div class="settings-help">When enabled, users will see a dropdown list of usernames when logging in.</div>
                            </div>

                            <div class="settings-item">
                                <div class="settings-toggle">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="allow-password-reset" class="toggle-checkbox">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Allow Password Reset</span>
                                    </label>
                                </div>
                                <div class="settings-help">When enabled, users can reset their passwords from the user page.</div>
                            </div>

                            <div class="settings-item">
                                <div class="settings-toggle">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="allow-suggestions" class="toggle-checkbox">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Allow User Suggestions</span>
                                    </label>
                                </div>
                                <div class="settings-help">When enabled, users can submit suggestions for improving answers.</div>
                            </div>

                            <div class="settings-item">
                                <div class="settings-toggle">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="allow-media-visibility" class="toggle-checkbox">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Show Videos & Images</span>
                                    </label>
                                </div>
                                <div class="settings-help">When enabled, users can see videos and images associated with answers.</div>
                            </div>
							
<div class="settings-item">
    <div class="settings-toggle" style="display: flex; align-items: center; justify-content: space-between;">
        <label class="toggle-label">
            <input type="checkbox" id="enforce-password-requirements" class="toggle-checkbox">
            <span class="toggle-slider"></span>
            <span class="toggle-text">Enforce Password Requirements</span>
        </label>
        <i id="password-reqs-arrow" class="fas fa-chevron-down" style="cursor: pointer; transition: transform 0.3s; margin-left: 10px; color: #6c757d;"></i>
    </div>
    <div id="password-reqs-collapsible" style="display: none; padding-left: 20px; margin-top: 15px; border-left: 2px solid #e9ecef;">
        <div class="settings-item" style="display: flex; align-items: center; justify-content: space-between;">
            <label class="toggle-label">
                <input type="checkbox" id="enforce-pw-min-length" class="toggle-checkbox">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Enforce Minimum Length</span>
            </label>
            <input type="number" id="pw-min-length-value" min="1" max="50" style="width: 60px; padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
        </div>
        <div class="settings-item">
            <label class="toggle-label">
                <input type="checkbox" id="enforce-pw-uppercase" class="toggle-checkbox">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Require Uppercase Letter (A-Z)</span>
            </label>
        </div>
        <div class="settings-item">
            <label class="toggle-label">
                <input type="checkbox" id="enforce-pw-lowercase" class="toggle-checkbox">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Require Lowercase Letter (a-z)</span>
            </label>
        </div>
        <div class="settings-item">
            <label class="toggle-label">
                <input type="checkbox" id="enforce-pw-number" class="toggle-checkbox">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Require Number (0-9)</span>
            </label>
        </div>
        <div class="settings-item">
            <label class="toggle-label">
                <input type="checkbox" id="enforce-pw-special" class="toggle-checkbox">
                <span class="toggle-slider"></span>
                <span class="toggle-text">Require Special Character (!@#$%)</span>
            </label>
        </div>
    </div>
    <div class="settings-help">When enabled, new passwords must meet the specified criteria.</div>
</div>
                        
						</div>

                        <div class="settings-actions">
                            <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
                            <button class="btn btn-secondary" onclick="resetSettings()">Reset to Defaults</button>
                            <div id="settings-status" style="display: none; margin-top: 10px; font-weight: 600;"></div>
                        </div>
                    </div>
                </div>

                <div id="change-password-section" class="content-section hidden">
					<div class="content-header">Admin Password & Account Management</div>
					<div id="current-user-indicator" style="background-color: #e9f3ff; border: 1px solid var(--primary-color); border-radius: 6px; padding: 10px; margin-bottom: 20px; text-align: center;">
						<span style="font-weight: 600; color: var(--primary-color);">
							Logged in as: <span id="current-admin-display">Loading...</span>
						</span>
					</div>
					
					<div class="admin-grid-container">

						<div class="admin-card">
							<div class="form-card">
								<h3 class="section-title">Change Your Password</h3>
								<div class="form-group">
									<label for="current-admin-password">Current Password</label>
									<input type="password" id="current-admin-password" placeholder="Enter current password..." autocomplete="current-password">
								</div>
								<div class="form-group">
									<label for="new-admin-password">New Password</label>
									<input type="password" id="new-admin-password" placeholder="Enter new password..." autocomplete="new-password">
									<div class="password-strength" id="password-strength" style="display: none;"></div>
								</div>
								<div class="form-group">
									<label for="confirm-admin-password">Confirm New Password</label>
									<input type="password" id="confirm-admin-password" placeholder="Confirm new password..." autocomplete="new-password">
									<div class="password-match" id="password-match" style="display: none;"></div>
								</div>
								<div style="text-align: center; margin-top: auto; padding-top: 20px;">
									<button class="btn btn-primary" onclick="changeAdminPassword()">Change Password</button>
								</div>
								<div id="password-change-status" style="display: none; margin-top: 15px; text-align: center; font-weight: 600;"></div>
							</div>
						</div>

						<div class="admin-card">
							<div class="form-card">
								<h3 class="section-title">Create New Admin</h3>
								<div class="form-group">
									<label for="new-admin-user-id">Admin User ID</label>
									<input type="text" id="new-admin-user-id" placeholder="Enter admin user ID..." autocomplete="off">
								</div>
								<div class="form-group">
									<label for="new-admin-user-password">Password</label>
									<input type="password" id="new-admin-user-password" placeholder="Enter password..." autocomplete="new-password">
								</div>
								<div class="form-group">
									<label for="confirm-new-admin-password">Confirm Password</label>
									<input type="password" id="confirm-new-admin-password" placeholder="Confirm password..." autocomplete="new-password">
									<div class="new-admin-password-match" id="new-admin-password-match" style="display: none;"></div>
								</div>
								<div style="text-align: center; margin-top: auto; padding-top: 20px;">
									<button class="btn btn-primary" onclick="createNewAdmin()">Create Admin</button>
								</div>
								<div id="create-admin-status" style="display: none; margin-top: 15px; text-align: center; font-weight: 600;"></div>
							</div>
						</div>

						<div class="admin-card">
							<div class="form-card">
								<h3 class="section-title">Current Admins</h3>
								<div id="admin-success-message" style="display: none; margin-bottom: 15px; color: #28a745; font-weight: 600; text-align: center;"></div>
								<div id="admin-list-container" style="border: 1px solid var(--border-color); border-radius: 8px; max-height: 250px; overflow-y: auto;">
									<div id="admin-list-loading" style="padding: 20px; text-align: center; color: #666;">Loading admins...</div>
									<div id="admin-list-empty" style="display: none; padding: 20px; text-align: center; color: #666;">No admins found.</div>
									<div id="admin-list" style="display: flex; flex-direction: column;"></div>
								</div>
								<div style="text-align: center; margin-top: auto; padding-top: 15px; display: flex; justify-content: center; gap: 10px;">
									<button class="btn btn-secondary" onclick="refreshAdminList()">Refresh</button>
									<button class="btn btn-danger" onclick="deleteSelectedAdmins()">Delete Selected</button>
								</div>
							</div>
						</div>

					</div>
				</div>
            </div>
        </div>
    </div>




<div id="media-modal" class="media-modal" style="display: none;">
    <div class="media-modal-content">
        <button class="media-modal-close" onclick="closeMediaModal()">&times;</button>
        <div id="media-modal-body"></div>
    </div>
</div>

<!-- Full Answer Modal -->
<div id="full-answer-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header" style="color: var(--primary-color); justify-content: space-between;">
            <span>Full Answer</span>
            <button class="media-modal-close" onclick="closeFullAnswerModal()" style="position: static; font-size: 20px;">&times;</button>
        </div>
        <div class="modal-content" style="max-height: 60vh; overflow-y: auto;">
            <p id="full-answer-text" style="white-space: pre-wrap;"></p>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeFullAnswerModal()">
                Close
            </button>
        </div>
    </div>
</div>

    <div id="delete-confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                Confirm Department Deletion
            </div>
            <div class="modal-content">
                <p><strong>Warning:</strong> You are about to permanently delete the following department(s):</p>
                <div id="departments-to-delete" class="department-list">
                    </div>
                <p><strong>This action cannot be undone.</strong> All users assigned to these departments may lose access.</p>
                <p>To confirm deletion, please type <strong>DELETE</strong> in the box below:</p>
                <input 
                    type="text" 
                    id="delete-confirmation-input" 
                    class="confirmation-input" 
                    placeholder="Type DELETE to confirm"
                    autocomplete="off"
                >
                <div class="confirmation-note">
                    Type exactly "DELETE" (case-sensitive) to enable the delete button
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="cancelDepartmentDeletion()">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="modal-btn modal-btn-delete" onclick="confirmDepartmentDeletion()">
                    Delete Departments
                </button>
            </div>
        </div>
    </div>
    
    <div id="delete-user-confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                Confirm User Deletion
            </div>
            <div class="modal-content">
                <p><strong>Warning:</strong> You are about to permanently delete the following user account(s):</p>
                <div id="users-to-delete" class="department-list">
                    </div>
                <p><strong>This action is irreversible.</strong></p>
                <p>To confirm deletion, please type <strong>DELETE</strong> in the box below:</p>
                <input 
                    type="text" 
                    id="delete-user-confirmation-input" 
                    class="confirmation-input" 
                    placeholder="Type DELETE to confirm"
                    autocomplete="off"
                >
                <div class="confirmation-note">
                    Type exactly "DELETE" (case-sensitive) to enable the delete button
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="cancelUserDeletion()">
                    Cancel
                </button>
                <button id="confirm-user-delete-btn" class="modal-btn modal-btn-delete" onclick="confirmUserDeletion()">
                    Delete Users
                </button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
        // Global state and Supabase config
       // Update your appState object to include these new properties:
let appState = { 
    currentPage: 'login', 
    currentMode: 'ask', 
    departments: [], 
    qaData: [],
    users: [],
    suggestions: [],			
    settings: {},
	 userQuestions: [],
    isLoading: false,
    currentReport: 'suggestions',
    suggestionsPage: 1,
    suggestionsPerPage: 10,
    suggestionsFilter: 'all',
    currentAdminUser: null,
    // Add these new properties:
    currentUser: null,
    currentUserType: null,
    currentQA: null,
	qaLog: [],
    qaLogPage: 1,
    qaLogPerPage: 20,
    qaLogFilters: {
        user: 'all',
        dateFrom: '',
        dateTo: ''
    }
};

document.addEventListener('DOMContentLoaded', async () => {
    // --- 1. INITIALIZE SUPABASE ---
    try {
        if (typeof supabase !== 'undefined' && supabase.createClient) {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            throw new Error('Supabase client library not found.');
        }
    } catch (error) {
        alert('Fatal Error: Could not initialize database connection. Check console for details.');
        console.error(error);
        return; 
    }

    // --- 2. SETUP EVENT LISTENERS (Consolidated) ---
    setupEventListeners();
    setupUserEventListeners();
    setupDeleteConfirmationInput();
    setupUserDeleteConfirmationInput();
    setupModalCloseOnOutsideClick();
    setupChatbotListeners();

    // Attach Settings Toggle Listeners
    const settingIds = ['allow-user-list', 'allow-password-reset', 'allow-suggestions', 'allow-media-visibility'];
    settingIds.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) {
            cb.addEventListener('change', async () => {
                const key = id.replace(/-/g, '_');
                if (!appState.settings) appState.settings = {};
                appState.settings[key] = cb.checked;
                await saveSettings();
            });
        }
    });
	

    // Attach Password Modal Listeners (Real-time Validation)
    const newPasswordField = document.getElementById('new-password');
    if (newPasswordField) {
        newPasswordField.addEventListener('input', () => {
            handlePasswordInput(newPasswordField);
            validatePasswordRealtime();
        });
    }
    const otherPasswordFields = ['current-password', 'confirm-new-password'];
    otherPasswordFields.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', () => handlePasswordInput(input));
        }
    });
	
	// Attach listeners for media feedback
const videoUrlInput = document.getElementById('video-url-input');
if (videoUrlInput) {
    videoUrlInput.addEventListener('input', () => {
        const feedback = document.getElementById('video-added-feedback');
        if (feedback) feedback.classList.toggle('hidden', !videoUrlInput.value.trim());
    });
}

const imageUploadInput = document.getElementById('image-upload-input');
if (imageUploadInput) {
    imageUploadInput.addEventListener('change', () => {
        const feedback = document.getElementById('image-added-feedback');
        if (feedback) feedback.classList.toggle('hidden', imageUploadInput.files.length === 0);
    });
}


    // --- 3. LOAD INITIAL DATA ---
    await loadInitialData();

    // --- 4. UPDATE UI FROM LOADED DATA ---
    if (appState.settings && appState.settings.site_title) {
        document.getElementById('site-title').textContent = appState.settings.site_title;
        document.getElementById('site-title-header').textContent = appState.settings.site_title;
    }
	
	
	
// Add this inside your DOMContentLoaded listener
const enforcePwToggle = document.getElementById('enforce-password-requirements');
const arrow = document.getElementById('password-reqs-arrow');

if (arrow) {
    arrow.addEventListener('click', () => {
        const collapsible = document.getElementById('password-reqs-collapsible');
        togglePasswordReqs(collapsible.style.display === 'none');
    });
}

if (enforcePwToggle) {
    enforcePwToggle.addEventListener('change', (e) => {
        togglePasswordReqs(e.target.checked);
        // Also add auto-saving for this toggle
        const key = 'enforce_password_requirements';
        if (!appState.settings) appState.settings = {};
        appState.settings[key] = e.target.checked;
        saveSettings();
    });
}
// Add auto-saving for sub-toggles
const subToggles = [
    'enforce-pw-min-length', 'enforce-pw-uppercase', 'enforce-pw-lowercase',
    'enforce-pw-number', 'enforce-pw-special'
];
subToggles.forEach(id => {
    const cb = document.getElementById(id);
    if (cb) {
        cb.addEventListener('change', async () => {
            const key = id.replace(/-/g, '_');
            if (!appState.settings) appState.settings = {};
            appState.settings[key] = cb.checked;
            await saveSettings();
        });
    }
});
const minLengthInput = document.getElementById('pw-min-length-value');
if(minLengthInput) {
    minLengthInput.addEventListener('change', async () => {
        if (!appState.settings) appState.settings = {};
        appState.settings.pw_min_length_value = parseInt(minLengthInput.value, 10) || 8;
        await saveSettings();
    });
}	
	

});

		let currentFileUrl = null;      // URL to open (http(s) or blob)
        let currentFileMime = null;     // e.g., "image/png" or "application/pdf"
        let fileObjectURL = null;       // blob URL we create for local file

		let currentImageUrl = null;      // first usable image URL for current QA
		let imagePreviewObjectURL = null; // blob URL for newly selected file

        // Global variable to store items to be deleted
        let departmentsToDelete = [];
        let usersToDelete = [];
        
        const SUPABASE_URL = 'https://ioljyppsrergyzxeecwb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvbGp5cHBzcmVyZ3l6eGVlY3diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NTE1MTEsImV4cCI6MjA3MTQyNzUxMX0.4hMYKTiGPW-YplD8JW_9jms9oFrQc9bcsFDp0Rgb2RE';

        // === SETTINGS FUNCTIONS (DEFINED FIRST TO AVOID ERRORS) ===
        
        // Load and display current settings
        // FIXED: Load and display current settings with proper toggle state handling
		async function loadAndDisplaySettings() {
			try {
				// Ensure settings are loaded
				await loadSettings();
				
				// Debug: Log what we loaded
				console.log('Loaded settings:', appState.settings);
				
				// Update site title fields
				const currentTitleField = document.getElementById('current-site-title');
				// Sync toggle checkboxes with loaded settings
				(function syncTogglesFromSettings() {
				  const map = {
					'allow-user-list': 'allow_user_list',
					'allow-password-reset': 'allow_password_reset',
					'allow-suggestions': 'allow_suggestions',
					'allow-media-visibility': 'allow_media_visibility'
				  };
				  Object.keys(map).forEach(id => {
					const el = document.getElementById(id);
					if (!el) return;
					const key = map[id];
					const val = appState.settings && typeof appState.settings[key] !== 'undefined' ? appState.settings[key] : false;
					el.checked = !!val;
				  });
				})();
			
				const newTitleField = document.getElementById('new-site-title');
				
				if (currentTitleField) {
					currentTitleField.value = appState.settings.site_title || 'Tally SOP';
				}
				if (newTitleField) {
					newTitleField.value = '';
					newTitleField.placeholder = 'Enter new site title...';
				}
				
				// Show or hide Reset Password button for user page
				const resetPasswordBtn = document.getElementById('reset-password-btn');
				if (resetPasswordBtn) {
					resetPasswordBtn.style.display = appState.settings.allow_password_reset === true ? 'inline-block' : 'none';
				}

				
				// FIXED: Update permission toggles with proper boolean handling
				const permissions = [
					'allow_user_list',
					'allow_password_reset', 
					'allow_suggestions',
					'allow_media_visibility'
				];
				
				permissions.forEach(permission => {
					const checkbox = document.getElementById(permission.replace('_', '-'));
					if (checkbox) {
						// FIXED: Properly handle boolean values from database
					   // REPLACE WITH THIS SINGLE LINE
		checkbox.checked = appState.settings[permission] === true;
						console.log(`Setting ${permission}: ${appState.settings[permission]} -> ${checkbox.checked}`);
					}
				});
				
				const changePasswordBtn = document.getElementById('change-password-btn');
				if (changePasswordBtn) {
					const isAllowed = appState.settings.allow_password_reset === true;
					const isNotAdmin = appState.currentUserType !== 'admin';
					changePasswordBtn.style.display = (isAllowed && isNotAdmin) ? 'inline-block' : 'none';
				}

				
			} catch (error) {
				console.error('Error loading settings:', error);
				showSettingsStatus('Error loading settings', 'error');
			}
			
			
			// Add this to the end of your loadAndDisplaySettings function
			// NEW: Password Requirements Settings
			const enforcePwToggle = document.getElementById('enforce-password-requirements');
			const enforceMinLengthToggle = document.getElementById('enforce-pw-min-length');
			const minLengthValueInput = document.getElementById('pw-min-length-value');
			const enforceUppercaseToggle = document.getElementById('enforce-pw-uppercase');
			const enforceLowercaseToggle = document.getElementById('enforce-pw-lowercase');
			const enforceNumberToggle = document.getElementById('enforce-pw-number');
			const enforceSpecialToggle = document.getElementById('enforce-pw-special');

			const settings = appState.settings || {};

			if (enforcePwToggle) enforcePwToggle.checked = settings.enforce_password_requirements === true;
			if (enforceMinLengthToggle) enforceMinLengthToggle.checked = settings.enforce_pw_min_length === true;
			if (minLengthValueInput) minLengthValueInput.value = settings.pw_min_length_value || 8;
			if (enforceUppercaseToggle) enforceUppercaseToggle.checked = settings.enforce_pw_uppercase === true;
			if (enforceLowercaseToggle) enforceLowercaseToggle.checked = settings.enforce_pw_lowercase === true;
			if (enforceNumberToggle) enforceNumberToggle.checked = settings.enforce_pw_number === true;
			if (enforceSpecialToggle) enforceSpecialToggle.checked = settings.enforce_pw_special === true;

			// Control visibility of the collapsible section on load
			togglePasswordReqs(settings.enforce_password_requirements === true);

			// Update the UI for the user password modal
			updatePasswordRequirementsUI();

		}
		async function loadQALog() {
    try {
        console.log('Loading Q&A log...');
        
        const { data, error } = await supabaseClient
            .from('qa_log')
            .select('*')
            .order('search_time', { ascending: false });
        
        if (error) {
            console.error('Error loading Q&A log:', error);
            console.error('Error details:', error.message);
            appState.qaLog = [];
            return;
        }
        
        console.log('Loaded Q&A log entries:', data?.length || 0);
        appState.qaLog = data || [];
        
        // Ensure users are loaded too for the filter
        if (!appState.users || appState.users.length === 0) {
            await loadUsers();
        }
        
        // Populate user filter dropdown
        populateUserFilter();
        
    } catch (error) {
        console.error('Exception loading Q&A log:', error);
        appState.qaLog = [];
    }
}

// Populate user filter dropdown
function populateUserFilter() {
    const userFilter = document.getElementById('qa-log-user-filter');
    if (!userFilter) return;
    
    // Get users from both qa_log and user_credentials
    const logUsers = [...new Set(appState.qaLog.map(log => log.user_id))];
    const allUsers = [...new Set([
        ...logUsers,
        ...(appState.users || []).map(user => user.user_id)
    ])].filter(Boolean).sort();
    
    userFilter.innerHTML = '<option value="all">All Users</option>';
    allUsers.forEach(user => {
        userFilter.innerHTML += `<option value="${user}">${user}</option>`;
    });
    
    console.log('Populated user filter with users:', allUsers);
}

// Filter Q&A log
function filterQALog() {
    const userFilter = document.getElementById('qa-log-user-filter').value;
    const dateFrom = document.getElementById('qa-log-date-from').value;
    const dateTo = document.getElementById('qa-log-date-to').value;
    
    appState.qaLogFilters = {
        user: userFilter,
        dateFrom: dateFrom,
        dateTo: dateTo
    };
    
    appState.qaLogPage = 1; // Reset to first page
    renderQALogTable();
}

// Render Q&A log table
function renderQALogTable() {
    const tableBody = document.getElementById('qa-log-table-body');
    const emptyState = document.getElementById('qa-log-empty');
    const loadingState = document.getElementById('qa-log-loading');
    
    if (!tableBody) return;

    loadingState.style.display = 'block';
    emptyState.style.display = 'none';
    tableBody.innerHTML = '';

    // Apply filters
    let filteredLog = appState.qaLog;
    if (appState.qaLogFilters.user !== 'all') {
        filteredLog = filteredLog.filter(log => log.user_id === appState.qaLogFilters.user);
    }
    if (appState.qaLogFilters.dateFrom) {
        const fromDate = new Date(appState.qaLogFilters.dateFrom);
        filteredLog = filteredLog.filter(log => new Date(log.search_time) >= fromDate);
    }
    if (appState.qaLogFilters.dateTo) {
        const toDate = new Date(appState.qaLogFilters.dateTo);
        toDate.setHours(23, 59, 59, 999);
        filteredLog = filteredLog.filter(log => new Date(log.search_time) <= toDate);
    }

    loadingState.style.display = 'none';

    if (filteredLog.length === 0) {
        emptyState.style.display = 'block';
        updateQALogStats(filteredLog);
        return;
    }

    // Pagination
    const startIndex = (appState.qaLogPage - 1) * appState.qaLogPerPage;
    const endIndex = startIndex + appState.qaLogPerPage;
    const paginatedLog = filteredLog.slice(startIndex, endIndex);

    tableBody.innerHTML = paginatedLog.map(log => {
        // Use the new safe date formatting function
        const searchTime = formatTimestamp(log.search_time); // Changed to search_time

        return `
            <tr>
                <td style="font-weight: 600;">${log.user_id}</td>
                <td style="max-width: 300px;">
                    <div class="truncated-text" title="${log.question_searched}">${log.question_searched}</div>
                </td>
                <td style="max-width: 300px;">
                    <div class="truncated-text" title="${log.answer_found || ''}">${log.answer_found || 'No answer'}</div>
                </td>
                <td style="white-space: nowrap;">${searchTime}</td>
            </tr>
        `;
    }).join('');

    updateQALogPagination(filteredLog.length);
    updateQALogStats(filteredLog);
}



// Update Q&A log statistics
function updateQALogStats(filteredLog) {
    const totalSearches = filteredLog.length;
    const uniqueUsers = new Set(filteredLog.map(log => log.user_id)).size;
    const successfulSearches = filteredLog.filter(log => 
        log.search_result === 'exact_match' || log.search_result === 'similar_match' || log.qa_id
    ).length;
    const successRate = totalSearches > 0 ? Math.round((successfulSearches / totalSearches) * 100) : 0;

    document.getElementById('total-searches').textContent = totalSearches;
    document.getElementById('unique-users').textContent = uniqueUsers;
    document.getElementById('success-rate').textContent = successRate + '%';
}

// Update pagination for Q&A log
function updateQALogPagination(totalItems) {
    const paginationDiv = document.getElementById('qa-log-pagination');
    const pageInfo = document.getElementById('qa-log-page-info');
    const prevBtn = document.getElementById('qa-log-prev-page');
    const nextBtn = document.getElementById('qa-log-next-page');
    
    if (!paginationDiv || totalItems <= appState.qaLogPerPage) {
        paginationDiv.style.display = 'none';
        return;
    }

    paginationDiv.style.display = 'block';
    
    const totalPages = Math.ceil(totalItems / appState.qaLogPerPage);
    const currentPage = appState.qaLogPage;
    
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;
}

// Change Q&A log page
function changeQALogPage(direction) {
    // Apply current filters to get filtered count
    let filteredLog = appState.qaLog;
    
    if (appState.qaLogFilters.user !== 'all') {
        filteredLog = filteredLog.filter(log => log.user_id === appState.qaLogFilters.user);
    }
    
    if (appState.qaLogFilters.dateFrom) {
        const fromDate = new Date(appState.qaLogFilters.dateFrom);
        filteredLog = filteredLog.filter(log => new Date(log.search_timestamp) >= fromDate);
    }
    
    if (appState.qaLogFilters.dateTo) {
        const toDate = new Date(appState.qaLogFilters.dateTo);
        toDate.setHours(23, 59, 59, 999);
        filteredLog = filteredLog.filter(log => new Date(log.search_timestamp) <= toDate);
    }
    
    const totalPages = Math.ceil(filteredLog.length / appState.qaLogPerPage);
    
    const newPage = appState.qaLogPage + direction;
    if (newPage >= 1 && newPage <= totalPages) {
        appState.qaLogPage = newPage;
        renderQALogTable();
    }
}

// Refresh Q&A log
async function refreshQALog() {
    const refreshBtn = document.querySelector('button[onclick="refreshQALog()"]');
    if (refreshBtn) {
        refreshBtn.textContent = 'Refreshing...';
        refreshBtn.disabled = true;
    }
    
    try {
        await loadQALog();
        renderQALogTable();
        showTemporaryMessage('Q&A log refreshed successfully!', 'success');
    } catch (error) {
        console.error('Error refreshing Q&A log:', error);
        showTemporaryMessage('Error refreshing Q&A log', 'error');
    } finally {
        if (refreshBtn) {
            refreshBtn.textContent = 'Refresh';
            refreshBtn.disabled = false;
        }
    }
}

// Export Q&A log to CSV
function exportQALog() {
    // Apply current filters
    let filteredLog = appState.qaLog;
    
    if (appState.qaLogFilters.user !== 'all') {
        filteredLog = filteredLog.filter(log => log.user_id === appState.qaLogFilters.user);
    }
    
    if (appState.qaLogFilters.dateFrom) {
        const fromDate = new Date(appState.qaLogFilters.dateFrom);
        filteredLog = filteredLog.filter(log => new Date(log.search_timestamp) >= fromDate);
    }
    
    if (appState.qaLogFilters.dateTo) {
        const toDate = new Date(appState.qaLogFilters.dateTo);
        toDate.setHours(23, 59, 59, 999);
        filteredLog = filteredLog.filter(log => new Date(log.search_timestamp) <= toDate);
    }

    if (filteredLog.length === 0) {
        alert('No data to export');
        return;
    }

    // Create CSV content
    const headers = ['User ID', 'Question Searched', 'Answer Found', 'Search Time', 'QA ID', 'Search Result'];
    const csvContent = [
        headers.join(','),
        ...filteredLog.map(log => [
            `"${log.user_id}"`,
            `"${(log.question_searched || '').replace(/"/g, '""')}"`,
            `"${(log.answer_found || '').replace(/"/g, '""')}"`,
            `"${new Date(log.search_timestamp).toLocaleString()}"`,
            log.qa_id || '',
            `"${log.search_result || ''}"`
        ].join(','))
    ].join('\n');

    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `qa_log_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
		// Show/hide forms in user page
function showAddQuestionForm() {
  // Hide the search section (correct ID)
  const searchSection = document.getElementById('user-search-section');
  if (searchSection) searchSection.style.display = 'none';

  const addSection = document.getElementById('user-add-section');
  if (addSection) addSection.style.display = 'block';

  const addBtn = document.getElementById('add-question-btn');
  if (addBtn) addBtn.style.display = 'none';

  const backBtn = document.getElementById('back-to-search-btn');
  if (backBtn) backBtn.style.display = 'inline-block';
}

function showSearchForm() {
  const searchSection = document.getElementById('user-search-section');
  if (searchSection) searchSection.style.display = 'block';

  const addSection = document.getElementById('user-add-section');
  if (addSection) addSection.style.display = 'none';

  const addBtn = document.getElementById('add-question-btn');
  if (addBtn) addBtn.style.display = 'inline-block';

  const backBtn = document.getElementById('back-to-search-btn');
  if (backBtn) backBtn.style.display = 'none';
}
function clearUserAddForm() {
    document.getElementById('new-user-question').value = '';
    document.getElementById('new-user-answer').value = '';
    document.getElementById('new-user-video').value = '';
    document.getElementById('new-user-images').value = '';
}

// Submit user question for approval
async function submitUserQuestion() {
    const question = document.getElementById('new-user-question').value.trim();
    const answer = document.getElementById('new-user-answer').value.trim();
    const videoUrl = document.getElementById('new-user-video').value.trim();
    const imageFiles = document.getElementById('new-user-images').files;

    // Validation
    if (!question) {
        alert('Please enter a question before submitting.');
        return;
    }

    if (!appState.currentUser) {
        alert('You must be logged in to submit a question.');
        return;
    }

    try {
        // You would need to handle image file uploads here in a real application.
        // For this fix, we'll just get the file names.
        let imageUrls = '';
        if (imageFiles && imageFiles.length > 0) {
            imageUrls = Array.from(imageFiles).map(file => file.name).join(',');
        }

        const userQuestion = {
            question: question,
            answer: answer || null,
            video_url: videoUrl || null,
            image_urls: imageUrls || null,
            departments: 'all', // Default to all departments for a new submission
            user_id: appState.currentUser,
            status: 'pending', // A new question should be pending approval
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        const { error } = await supabaseClient
            .from('user_questions')
            .insert([userQuestion]);

        if (error) {
            console.error('Error submitting question:', error);
            alert('Error submitting question: ' + error.message);
            return;
        }

        alert('Your question has been submitted successfully and is pending admin approval!');
        
        // Clear the form fields
        document.getElementById('new-user-question').value = '';
        document.getElementById('new-user-answer').value = '';
        document.getElementById('new-user-video').value = '';
        document.getElementById('new-user-images').value = '';
        
        // Return to the search form
        showSearchForm();

    } catch (error) {
        console.error('Exception submitting question:', error);
        alert('An unexpected error occurred while submitting your question.');
    }
}


// Add updatePasswordRequirementsUI() to this function
function openChangePasswordModal() {
    updatePasswordRequirementsUI(); // Add this line
    document.getElementById('change-password-modal').style.display = 'flex';
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-new-password').value = '';
    document.getElementById('password-match-msg').textContent = '';
    document.getElementById('confirm-change-password').disabled = true;
    validatePasswordRealtime(); // Call this to clear any old checkmarks
}



		function closeChangePasswordModal() {
			document.getElementById('change-password-modal').style.display = 'none';
		}

		document.getElementById('confirm-new-password').addEventListener('input', function () {
			const pass = document.getElementById('new-password').value.trim();
			const confirm = this.value.trim();
			const msg = document.getElementById('password-match-msg');
			const confirmBtn = document.getElementById('confirm-change-password');

			if (pass && confirm) {
				if (pass.length < 6) {
					msg.textContent = 'Password must be at least 6 characters.';
					msg.style.color = '#dc3545';
					confirmBtn.disabled = true;
				} else if (pass === confirm) {
					msg.textContent = 'Passwords match.';
					msg.style.color = '#28a745';
					confirmBtn.disabled = false;
				} else {
					msg.textContent = 'Passwords do not match.';
					msg.style.color = '#dc3545';
					confirmBtn.disabled = true;
				}
			} else {
				msg.textContent = '';
				confirmBtn.disabled = true;
			}
		});
		
		/**
		 * Validates a password against a set of security rules.
		 * @param {string} password The password to validate.
		 * @returns {{isValid: boolean, message: string}} An object with validation status and a message.
		 */
// Replace the entire validatePassword function
function validatePassword(password) {
    const settings = appState.settings || {};

    // If enforcement is off, any non-empty password is valid
    if (settings.enforce_password_requirements === false) {
        if (!password || password.length < 1) {
            return { isValid: false, message: 'Password cannot be empty.' };
        }
        return { isValid: true, message: 'Password is valid.' };
    }

    // Enforcement is ON, check rules based on settings
    if (settings.enforce_pw_min_length) {
        const minLength = settings.pw_min_length_value || 8;
        if (password.length < minLength) {
            return { isValid: false, message: `Password must be at least ${minLength} characters long.` };
        }
    }
    if (settings.enforce_pw_uppercase && !/[A-Z]/.test(password)) {
        return { isValid: false, message: 'Password must include at least one uppercase letter.' };
    }
    if (settings.enforce_pw_lowercase && !/[a-z]/.test(password)) {
        return { isValid: false, message: 'Password must include at least one lowercase letter.' };
    }
    if (settings.enforce_pw_number && !/[0-9]/.test(password)) {
        return { isValid: false, message: 'Password must include at least one number.' };
    }
    if (settings.enforce_pw_special && !/[^A-Za-z0-9]/.test(password)) {
        return { isValid: false, message: 'Password must include at least one special character (e.g., !@#$%).' };
    }
    
    return { isValid: true, message: 'Password is valid.' };
}



		async function confirmChangePassword() {
			const currentPass = document.getElementById('current-password').value.trim();
			const newPass = document.getElementById('new-password').value.trim();

			// --- VALIDATION BLOCK ---
			const passwordValidation = validatePassword(newPass);
			if (!passwordValidation.isValid) {
				alert(passwordValidation.message);
				return;
			} // <-- The missing brace is now added here.

			if (!appState.currentUser) {
				alert("You must be logged in to change your password.");
				return;
			}

			try {
				const { data: userData, error: fetchError } = await supabaseClient
					.from('user_credentials')
					.select('password')
					.eq('user_id', appState.currentUser)
					.single();

				if (fetchError) throw fetchError;
				
				if (userData.password !== currentPass) {
					alert("Current password is incorrect.");
					return;
				}

				const { error: updateError } = await supabaseClient
					.from('user_credentials')
					.update({ password: newPass })
					.eq('user_id', appState.currentUser);

				if (updateError) throw updateError;

				alert("Password changed successfully!");
				closeChangePasswordModal();
			} catch (err) {
				console.error("Error changing password:", err);
				alert("Failed to change password. Please try again.");
			}
		}

		// Show/hide Change Password button based on settings and role
		const changePasswordBtn = document.getElementById('change-password-btn');
		if (changePasswordBtn) {
			const isAllowed = appState.settings.allow_password_reset === true;
			const isNotAdmin = appState.currentUserRole !== 'admin'; // Adjust property name if needed
			changePasswordBtn.style.display = (isAllowed && isNotAdmin) ? 'inline-block' : 'none';
		}
		
		async function resetUserPassword() {
			if (!appState.currentUser) {
				alert("You must be logged in to reset your password.");
				return;
			}

			const newPassword = prompt("Enter your new password:");
			if (!newPassword || newPassword.trim().length < 6) {
				alert("Password must be at least 6 characters.");
				return;
			}

			try {
				const { error } = await supabaseClient
					.from('users')
					.update({ password: newPassword.trim() }) // No hashing (you can add hashing here later)
					.eq('uid', appState.currentUser);

				if (error) throw error;

				alert("Password reset successfully!");
			} catch (err) {
				console.error("Error resetting password:", err);
				alert("Failed to reset password. Please try again.");
			}
		}



        // Update site title
        async function updateSiteTitle() {
            const newTitleField = document.getElementById('new-site-title');
            if (!newTitleField) {
                console.error('New site title field not found');
                return;
            }
            
            const newTitle = newTitleField.value.trim();
            
            if (!newTitle) {
                showSettingsStatus('Please enter a new site title', 'error');
                return;
            }
            
            if (newTitle.length > 100) {
                showSettingsStatus('Site title must be 100 characters or less', 'error');
                return;
            }
            
            try {
                // Update in database
                const { error } = await supabaseClient
                    .from('settings')
                    .upsert({
                        id: 1,
                        site_title: newTitle,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) {
                    showSettingsStatus('Error updating site title: ' + error.message, 'error');
                    return;
                }
                
                // Update local state
                if (!appState.settings) appState.settings = {};
                appState.settings.site_title = newTitle;
                
                // Update UI immediately
                document.getElementById('current-site-title').value = newTitle;
                document.getElementById('site-title').textContent = newTitle;
                document.getElementById('site-title-header').textContent = newTitle;
                newTitleField.value = '';
                
                showSettingsStatus('Site title updated successfully!', 'success');
                
            } catch (error) {
                console.error('Exception updating site title:', error);
                showSettingsStatus('Unexpected error updating site title', 'error');
            }
        }

        // Save all settings
async function saveSettings() {
            try {
                // Collect values from ALL settings fields on the page
                const settings = {
                    id: 1, // We are always updating the single settings row with id = 1
                    site_title: (appState.settings && appState.settings.site_title) || 'Tally SOP',
                    allow_user_list: document.getElementById('allow-user-list').checked,
                    allow_password_reset: document.getElementById('allow-password-reset').checked,
                    allow_suggestions: document.getElementById('allow-suggestions').checked,
                    allow_media_visibility: document.getElementById('allow-media-visibility').checked,
                    
                    // Add the new password requirement values
                    enforce_password_requirements: document.getElementById('enforce-password-requirements').checked,
                    enforce_pw_min_length: document.getElementById('enforce-pw-min-length').checked,
                    pw_min_length_value: parseInt(document.getElementById('pw-min-length-value').value, 10) || 8,
                    enforce_pw_uppercase: document.getElementById('enforce-pw-uppercase').checked,
                    enforce_pw_lowercase: document.getElementById('enforce-pw-lowercase').checked,
                    enforce_pw_number: document.getElementById('enforce-pw-number').checked,
                    enforce_pw_special: document.getElementById('enforce-pw-special').checked,
                    
                    updated_at: new Date().toISOString()
                };
                
                // Save to the database
                const { error } = await supabaseClient
                    .from('settings')
                    .upsert(settings);
                
                if (error) {
                    showSettingsStatus('Error saving settings: ' + error.message, 'error');
                    return;
                }
                
                // Update local state and show success
                appState.settings = settings;
                showSettingsStatus('Settings saved successfully!', 'success');
                
            } catch (error) {
                console.error('Exception saving settings:', error);
                showSettingsStatus('Unexpected error saving settings', 'error');
            }
}

        // Reset settings to defaults
        async function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to default values? This action cannot be undone.')) {
                return;
            }
            
            try {
                const defaultSettings = {
                    id: 1,
                    site_title: 'Tally SOP',
                    allow_user_list: true,
                    allow_password_reset: true,
                    allow_suggestions: true,
                    allow_media_visibility: true,
                    updated_at: new Date().toISOString()
                };
                
                // Save to database
                const { error } = await supabaseClient
                    .from('settings')
                    .upsert(defaultSettings);
                
                if (error) {
                    showSettingsStatus('Error resetting settings: ' + error.message, 'error');
                    return;
                }
                
                // Update local state
                appState.settings = defaultSettings;
                
                // Update UI
                document.getElementById('site-title').textContent = defaultSettings.site_title;
                document.getElementById('site-title-header').textContent = defaultSettings.site_title;
                
                // Reload settings display
                loadAndDisplaySettings();
                
                showSettingsStatus('Settings reset to defaults successfully!', 'success');
                
            } catch (error) {
                console.error('Exception resetting settings:', error);
                showSettingsStatus('Unexpected error resetting settings', 'error');
            }
        }

        // Show settings status message
        function showSettingsStatus(message, type = 'info') {
            const statusDiv = document.getElementById('settings-status');
            if (!statusDiv) {
                console.log('Settings status:', message);
                return;
            }
            
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Set color based on type
            switch (type) {
                case 'success':
                    statusDiv.style.color = '#28a745';
                    break;
                case 'error':
                    statusDiv.style.color = '#dc3545';
                    break;
                default:
                    statusDiv.style.color = '#6c757d';
            }
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                if (statusDiv) statusDiv.style.display = 'none';
            }, 4000);
        }

        // Get current setting value (helper function for user page)
        function getSetting(settingName, defaultValue = true) {
            return appState.settings && appState.settings[settingName] !== undefined 
                ? appState.settings[settingName] 
                : defaultValue;
        }

        // === ADMIN PASSWORD & MANAGEMENT FUNCTIONS ===
        
        // Change admin password
        async function changeAdminPassword() {
			const currentPassword = document.getElementById('current-admin-password').value.trim();
			const newPassword = document.getElementById('new-admin-password').value.trim();
			const confirmPassword = document.getElementById('confirm-admin-password').value.trim();
			
			showPasswordStatus('', 'clear');

			// --- VALIDATION BLOCK (Corrected and de-duplicated) ---
			const passwordValidation = validatePassword(newPassword);
			if (!passwordValidation.isValid) {
				showPasswordStatus(passwordValidation.message, 'error');
				return;
			} // <-- The missing brace is now added here.
			
			if (!appState.currentAdminUser) {
				showPasswordStatus('Unable to identify current admin user', 'error');
				return;
			}
			
			if (!currentPassword) {
				showPasswordStatus('Please enter your current password', 'error');
				return;
			}
			
			if (newPassword !== confirmPassword) {
				showPasswordStatus('New passwords do not match', 'error');
				return;
			}
			
			if (currentPassword === newPassword) {
				showPasswordStatus('New password must be different from current password', 'error');
				return;
			}
			
			try {
				const currentAdminId = appState.currentAdminUser;
				
				const { data: adminData, error: verifyError } = await supabaseClient
					.from('admin_credentials')
					.select('password')
					.eq('user_id', currentAdminId)
					.single();
				
				if (verifyError || !adminData) {
					showPasswordStatus(`Admin account '${currentAdminId}' not found`, 'error');
					return;
				}
				
				if (adminData.password !== currentPassword) {
					showPasswordStatus('Current password is incorrect', 'error');
					return;
				}
				
				const { error: updateError } = await supabaseClient
					.from('admin_credentials')
					.update({
						password: newPassword,
						updated_at: new Date().toISOString()
					})
					.eq('user_id', currentAdminId);
				
				if (updateError) {
					showPasswordStatus('Error updating password: ' + updateError.message, 'error');
					return;
				}
				
				document.getElementById('current-admin-password').value = '';
				document.getElementById('new-admin-password').value = '';
				document.getElementById('confirm-admin-password').value = '';
				
				showPasswordStatus(`Password changed successfully for '${currentAdminId}'!`, 'success');
				
			} catch (error) {
				console.error('Exception changing password:', error);
				showPasswordStatus('Unexpected error changing password', 'error');
			}
		}
        
        // Create new admin
        async function createNewAdmin() {
            const userId = document.getElementById('new-admin-user-id').value.trim();
            const password = document.getElementById('new-admin-user-password').value.trim();
            const confirmPassword = document.getElementById('confirm-new-admin-password').value.trim();
            
            // Clear previous status
            showCreateAdminStatus('', 'clear');
            
            // Validation
            if (!userId) {
                showCreateAdminStatus('Please enter admin user ID', 'error');
                return;
            }
            
            if (userId.length < 3) {
                showCreateAdminStatus('User ID must be at least 3 characters long', 'error');
                return;
            }
            
            if (!password) {
                showCreateAdminStatus('Please enter password', 'error');
                return;
            }
            
            if (password.length < 6) {
                showCreateAdminStatus('Password must be at least 6 characters long', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showCreateAdminStatus('Passwords do not match', 'error');
                return;
            }
            
            try {
                // Check if admin already exists
                const { data: existingAdmin, error: checkError } = await supabaseClient
                    .from('admin_credentials')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single();
                
                if (existingAdmin) {
                    showCreateAdminStatus('Admin with this user ID already exists', 'error');
                    return;
                }
                
                // Create new admin
                const { error: createError } = await supabaseClient
                    .from('admin_credentials')
                    .insert({
                        user_id: userId,
                        password: password,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                
                if (createError) {
                    showCreateAdminStatus('Error creating admin: ' + createError.message, 'error');
                    return;
                }
                
                // Clear form
                document.getElementById('new-admin-user-id').value = '';
                document.getElementById('new-admin-user-password').value = '';
                document.getElementById('confirm-new-admin-password').value = '';
                
                showCreateAdminStatus('Admin created successfully!', 'success');
                
                // Refresh admin list
                setTimeout(() => {
                    loadAdminList();
                }, 1000);
                
            } catch (error) {
                console.error('Exception creating admin:', error);
                showCreateAdminStatus('Unexpected error creating admin', 'error');
            }
        }
		
		
        // Shows the modal with the full answer text
		function showFullAnswerModal(answerText) {
			const modal = document.getElementById('full-answer-modal');
			const textElement = document.getElementById('full-answer-text');
			
			textElement.textContent = answerText;
			modal.style.display = 'flex';
		}

		// Hides the modal
		function closeFullAnswerModal() {
			const modal = document.getElementById('full-answer-modal');
			modal.style.display = 'none';
		}


        // Load admin list
        async function loadAdminList() {
            const loadingDiv = document.getElementById('admin-list-loading');
            const emptyDiv = document.getElementById('admin-list-empty');
            const listDiv = document.getElementById('admin-list');
            
            // Show loading
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (emptyDiv) emptyDiv.style.display = 'none';
            if (listDiv) listDiv.innerHTML = '';
            
            try {
                const { data: admins, error } = await supabaseClient
                    .from('admin_credentials')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                // Hide loading
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                if (error) {
                    console.error('Error loading admins:', error);
                    if (emptyDiv) {
                        emptyDiv.textContent = 'Error loading admins';
                        emptyDiv.style.display = 'block';
                    }
                    return;
                }
                
                if (!admins || admins.length === 0) {
                    if (emptyDiv) emptyDiv.style.display = 'block';
                    return;
                }
                
                // Render admin list
                const currentAdmin = appState.currentAdminUser || 'unknown'; // Use actual logged-in admin
                const adminHtml = admins.map(admin => {
                    const createdDate = new Date(admin.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const isCurrentAdmin = admin.user_id === currentAdmin;
                    const disabledAttr = isCurrentAdmin ? 'disabled' : '';
                    const currentBadge = isCurrentAdmin ? '<span class="current-admin-badge">Current</span>' : '';
                    
                    return `
                        <div class="admin-item">
                            <input type="checkbox" class="admin-checkbox" value="${admin.user_id}" ${disabledAttr}>
                            <div class="admin-info">
                                <div class="admin-user-id">${admin.user_id}${currentBadge}</div>
                                <div class="admin-created-date">Created: ${createdDate}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (listDiv) listDiv.innerHTML = adminHtml;
                
            } catch (error) {
                console.error('Exception loading admins:', error);
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (emptyDiv) {
                    emptyDiv.textContent = 'Error loading admins';
                    emptyDiv.style.display = 'block';
                }
            }
        }
        
        // Refresh admin list
        async function refreshAdminList() {
            const refreshBtn = document.querySelector('button[onclick="refreshAdminList()"]');
            if (refreshBtn) {
                refreshBtn.textContent = 'Refreshing...';
                refreshBtn.disabled = true;
            }
            
            await loadAdminList();
            
            if (refreshBtn) {
                refreshBtn.textContent = 'Refresh';
                refreshBtn.disabled = false;
            }
            
            showAdminSuccessMessage('Admin list refreshed');
        }
		
		// Handles 'View' button clicks
        function viewMedia(type) {
            let url;
            if (type === 'video') {
                url = document.getElementById('video-url-input').value.trim();
                if (!url) {
                    alert('No video URL is available to view.');
                    return;
                }
            } else { // image
                const previewLink = document.getElementById('image-preview-link');
                url = previewLink ? previewLink.href : null;
                if (!url || url === '#') {
                    alert('No image or file is available to view.');
                    return;
                }
            }
            // Open the URL in a new browser tab
            window.open(url, '_blank');
        }
        
        // Delete selected admins
        async function deleteSelectedAdmins() {
            const checkboxes = document.querySelectorAll('.admin-checkbox:checked:not(:disabled)');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one admin to delete (you cannot delete your own account).');
                return;
            }
            
            const adminIds = Array.from(checkboxes).map(cb => cb.value);
            
            // Confirmation dialog
            const confirmMessage = `⚠️ WARNING: This action is irreversible!\n\nYou are about to permanently delete ${adminIds.length === 1 ? 'this admin account' : 'these ' + adminIds.length + ' admin accounts'}:\n\n${adminIds.join(', ')}\n\nAre you absolutely sure you want to proceed?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for safety
            const doubleConfirm = confirm('This is your final confirmation. Are you sure you want to delete these admin accounts? This cannot be undone.');
            if (!doubleConfirm) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('admin_credentials')
                    .delete()
                    .in('user_id', adminIds);
                
                if (error) {
                    alert('Error deleting admins: ' + error.message);
                    return;
                }
                
                showAdminSuccessMessage(`${adminIds.length === 1 ? 'Admin' : 'Admins'} deleted successfully`);
                
                // Refresh list
                setTimeout(() => {
                    loadAdminList();
                }, 1000);
                
            } catch (error) {
                console.error('Exception deleting admins:', error);
                alert('Unexpected error deleting admins');
            }
        }
        
        // Show password change status
        function showPasswordStatus(message, type = 'info') {
            const statusDiv = document.getElementById('password-change-status');
            if (!statusDiv) return;
            
            if (type === 'clear') {
                statusDiv.style.display = 'none';
                statusDiv.textContent = '';
                return;
            }
            
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            switch (type) {
                case 'success':
                    statusDiv.style.color = '#28a745';
                    break;
                case 'error':
                    statusDiv.style.color = '#dc3545';
                    break;
                default:
                    statusDiv.style.color = '#6c757d';
            }
            
            if (type === 'success') {
                setTimeout(() => {
                    if (statusDiv) statusDiv.style.display = 'none';
                }, 4000);
            }
        }
        // Load user questions from database
async function loadUserQuestions() {
    try {
        const { data, error } = await supabaseClient
            .from('user_questions')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading user questions:', error);
            appState.userQuestions = [];
            return;
        }
        
        appState.userQuestions = data || [];
    } catch (error) {
        console.error('Exception loading user questions:', error);
        appState.userQuestions = [];
    }
}

// Render user questions table
function renderUserQuestionsTable() {
    const tableBody = document.getElementById('user-questions-table-body');
    const emptyState = document.getElementById('user-questions-empty');
    
    if (!tableBody) return;

    let filteredQuestions = appState.userQuestions || [];
    const statusFilter = document.getElementById('user-questions-status-filter');
    if (statusFilter && statusFilter.value !== 'all') {
        filteredQuestions = filteredQuestions.filter(q => q.status === statusFilter.value);
    }

    if (filteredQuestions.length === 0) {
        emptyState.style.display = 'block';
        tableBody.innerHTML = '';
        return;
    }

    emptyState.style.display = 'none';

    tableBody.innerHTML = filteredQuestions.map(question => {
        const createdDate = new Date(question.created_at).toLocaleDateString('en-US', {
            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        const statusDropdown = `
            <select class="action-dropdown" onchange="updateUserQuestionStatus(${question.id}, this.value)">
                <option value="pending" ${question.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="read" ${question.status === 'read' ? 'selected' : ''}>Mark as Read</option>
                <option value="approved" ${question.status === 'approved' ? 'selected' : ''}>Approved</option>
            </select>
        `;

        const hasMedia = (question.video_url || question.image_urls) ? 'Yes' : 'No';

        return `
            <tr>
                <td style="max-width: 200px; word-wrap: break-word;">${question.question || 'N/A'}</td>
                <td style="max-width: 200px; word-wrap: break-word;">${question.answer || 'Not provided'}</td>
                <td style="text-align: center;">${hasMedia}</td>
                <td>${question.user_id || 'Anonymous'}</td>
                <td style="white-space: nowrap;">${createdDate}</td>
                <td style="text-align: center;">${statusDropdown}</td>
            </tr>
        `;
    }).join('');
}

// Update user question status
async function updateUserQuestionStatus(questionId, newStatus) {
    try {
        const question = appState.userQuestions.find(q => q.id === questionId);
        if (!question) return;

        if (newStatus === 'approved') {
            // Move to qa table
            const qaData = {
                question: question.question,
                answer: question.answer || '',
                video_url: question.video_url,
                image_urls: question.image_urls,
                departments: question.departments || 'all'
            };

            const { error: qaError } = await supabaseClient
                .from('qa')
                .insert([qaData]);

            if (qaError) {
                alert('Error moving question to Q&A database: ' + qaError.message);
                return;
            }

            // Update Q&A data in memory
            await loadQA();
        }

        // Update status in user_questions table
        const { error } = await supabaseClient
            .from('user_questions')
            .update({
                status: newStatus,
                reviewed_by: appState.currentAdminUser || 'admin',
                reviewed_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .eq('id', questionId);

        if (error) {
            alert('Error updating question status: ' + error.message);
            return;
        }

        // Update local state
        const localQuestion = appState.userQuestions.find(q => q.id === questionId);
        if (localQuestion) {
            localQuestion.status = newStatus;
            localQuestion.reviewed_by = appState.currentAdminUser || 'admin';
            localQuestion.reviewed_at = new Date().toISOString();
        }

        renderUserQuestionsTable();
        
        if (newStatus === 'approved') {
            showTemporaryMessage('Question approved and moved to Q&A database!', 'success');
        } else {
            showTemporaryMessage('Question status updated successfully!', 'success');
        }

    } catch (error) {
        console.error('Exception updating question status:', error);
        alert('An unexpected error occurred while updating the question status.');
    }
}

// Refresh user questions
async function refreshUserQuestions() {
    const refreshBtn = document.querySelector('button[onclick="refreshUserQuestions()"]');
    if (refreshBtn) {
        refreshBtn.textContent = 'Refreshing...';
        refreshBtn.disabled = true;
    }
    
    try {
        await loadUserQuestions();
        renderUserQuestionsTable();
        showTemporaryMessage('User questions refreshed successfully!', 'success');
    } catch (error) {
        console.error('Error refreshing user questions:', error);
        showTemporaryMessage('Error refreshing user questions', 'error');
    } finally {
        if (refreshBtn) {
            refreshBtn.textContent = 'Refresh';
            refreshBtn.disabled = false;
        }
    }
}
        // Show create admin status
        function showCreateAdminStatus(message, type = 'info') {
            const statusDiv = document.getElementById('create-admin-status');
            if (!statusDiv) return;
            
            if (type === 'clear') {
                statusDiv.style.display = 'none';
                statusDiv.textContent = '';
                return;
            }
            
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            switch (type) {
                case 'success':
                    statusDiv.style.color = '#28a745';
                    break;
                case 'error':
                    statusDiv.style.color = '#dc3545';
                    break;
                default:
                    statusDiv.style.color = '#6c757d';
            }
            
            if (type === 'success') {
                setTimeout(() => {
                    if (statusDiv) statusDiv.style.display = 'none';
                }, 4000);
            }
        }
        
        // Show admin success message
        function showAdminSuccessMessage(message) {
            const messageDiv = document.getElementById('admin-success-message');
            if (!messageDiv) return;
            
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                if (messageDiv) messageDiv.style.display = 'none';
            }, 3000);
        }
        
        // Setup password validation
        function setupPasswordValidation() {
            const newPasswordField = document.getElementById('new-admin-password');
            const confirmPasswordField = document.getElementById('confirm-admin-password');
            const strengthDiv = document.getElementById('password-strength');
            const matchDiv = document.getElementById('password-match');
            
            if (newPasswordField && strengthDiv) {
                newPasswordField.addEventListener('input', function() {
                    const password = this.value;
                    if (password.length === 0) {
                        strengthDiv.style.display = 'none';
                        return;
                    }
                    
                    strengthDiv.style.display = 'block';
                    
                    if (password.length < 6) {
                        strengthDiv.className = 'password-strength strength-weak';
                        strengthDiv.textContent = 'Weak: Password too short';
                    } else if (password.length < 10) {
                        strengthDiv.className = 'password-strength strength-medium';
                        strengthDiv.textContent = 'Medium: Consider adding numbers or symbols';
                    } else {
                        strengthDiv.className = 'password-strength strength-strong';
                        strengthDiv.textContent = 'Strong: Good password';
                    }
                });
            }
            
            if (confirmPasswordField && matchDiv) {
                confirmPasswordField.addEventListener('input', function() {
                    const confirmPassword = this.value;
                    const newPassword = newPasswordField ? newPasswordField.value : '';
                    
                    if (confirmPassword.length === 0) {
                        matchDiv.style.display = 'none';
                        return;
                    }
                    
                    matchDiv.style.display = 'block';
                    
                    if (confirmPassword === newPassword) {
                        matchDiv.className = 'password-match match-success';
                        matchDiv.textContent = '✓ Passwords match';
                    } else {
                        matchDiv.className = 'password-match match-error';
                        matchDiv.textContent = '✗ Passwords do not match';
                    }
                });
            }
            
            // Setup new admin password validation
            const newAdminPasswordField = document.getElementById('new-admin-user-password');
            const confirmNewAdminField = document.getElementById('confirm-new-admin-password');
            const newAdminMatchDiv = document.getElementById('new-admin-password-match');
            
            if (confirmNewAdminField && newAdminMatchDiv) {
                confirmNewAdminField.addEventListener('input', function() {
                    const confirmPassword = this.value;
                    const newPassword = newAdminPasswordField ? newAdminPasswordField.value : '';
                    
                    if (confirmPassword.length === 0) {
                        newAdminMatchDiv.style.display = 'none';
                        return;
                    }
                    
                    newAdminMatchDiv.style.display = 'block';
                    
                    if (confirmPassword === newPassword) {
                        newAdminMatchDiv.className = 'new-admin-password-match match-success';
                        newAdminMatchDiv.textContent = '✓ Passwords match';
                    } else {
                        newAdminMatchDiv.className = 'new-admin-password-match match-error';
                        newAdminMatchDiv.textContent = '✗ Passwords do not match';
                    }
                });
            }
        }

        // === END ADMIN PASSWORD & MANAGEMENT FUNCTIONS ===

        // === END SETTINGS FUNCTIONS ===

        // Initialize App


        function joinPublicUrl(base, path) {
          if (!base) return path; // already a URL
          if (!base.endsWith('/')) base += '/';
          return base + path.split('/').map(s => encodeURIComponent(s)).join('/');
        }
        const IMAGE_BASE_URL =
          (appState.settings && appState.settings.image_base_url) || ''; // leave '' if you store full URLs
        
        function renderImageGallery(urls) {
          const holder = document.getElementById('current-images-display');
          if (!holder) return;
          if (!urls || urls.length === 0) {
            holder.innerHTML = '';
            holder.style.display = 'none';
            return;
          }
          holder.style.display = 'block';
          holder.innerHTML = `
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start;">
              ${urls.map(u => {
                const isPdf = u.toLowerCase().endsWith('.pdf');
                return isPdf
                  ? `<a href="${u}" target="_blank" style="padding:6px 8px;border:1px solid #dee2e6;border-radius:6px;text-decoration:none;">PDF</a>`
                  : `<a href="${u}" target="_blank" style="display:inline-block;border:1px solid #dee2e6;border-radius:6px;">
                       <img src="${u}" alt="img" style="max-width:100px; max-height:80px; display:block;">
                     </a>`;
              }).join('')}
            </div>`;
        }

        // Setup all event listeners
function setupEventListeners() {
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    
    const adminQuestionInput = document.getElementById('admin-question');
    adminQuestionInput.addEventListener('input', handleQuestionInput);
    adminQuestionInput.addEventListener('blur', () => setTimeout(() => {
        document.getElementById('admin-prediction-list').style.display = 'none';
    }, 200));

    const deptDropdownBtn = document.getElementById('dept-dropdown-btn');
    const deptCheckboxPanel = document.getElementById('qa-department-checkbox');
    
    if (deptDropdownBtn && deptCheckboxPanel) {
        deptDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deptCheckboxPanel.classList.toggle('hidden');
        });
    }

    const addDeptDropdownBtn = document.getElementById('add-dept-dropdown-btn');
    const addDeptCheckboxPanel = document.getElementById('add-department-checkbox');

    if (addDeptDropdownBtn && addDeptCheckboxPanel) {
        addDeptDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            addDeptCheckboxPanel.classList.toggle('hidden');
        });
    }
    
    document.addEventListener('click', (event) => {
        if (deptCheckboxPanel && !deptDropdownBtn.contains(event.target) && !deptCheckboxPanel.contains(event.target)) {
            deptCheckboxPanel.classList.add('hidden');
        }
        if (addDeptCheckboxPanel && !addDeptDropdownBtn.contains(event.target) && !addDeptCheckboxPanel.contains(event.target)) {
            addDeptCheckboxPanel.classList.add('hidden');
        }
    });

    // Department management event listeners
    document.getElementById('create-dept-btn')?.addEventListener('click', createDepartment);
    document.getElementById('new-dept-name')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            createDepartment();
        }
    });
    document.getElementById('delete-dept-btn')?.addEventListener('click', deleteDepartments);

    // Password Modal Listeners (Real-time Validation)
    document.getElementById('new-password')?.addEventListener('input', validatePasswordRealtime);
    ['current-password', 'new-password', 'confirm-new-password'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.addEventListener('input', () => handlePasswordInput(input));
    });

    // Attach Settings Auto-Save Listeners
    const settingIds = [
        'allow-user-list', 'allow-password-reset', 'allow-suggestions', 
        'allow-media-visibility', 'enforce-password-requirements', 'enforce-pw-min-length', 
        'enforce-pw-uppercase', 'enforce-pw-lowercase', 'enforce-pw-number', 'enforce-pw-special'
    ];
    settingIds.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) {
            cb.addEventListener('change', async () => await saveSettings());
        }
    });
    const minLengthInput = document.getElementById('pw-min-length-value');
    if(minLengthInput) {
        minLengthInput.addEventListener('change', async () => await saveSettings());
    }

    // UI Listener for collapsible arrow
    const arrow = document.getElementById('password-reqs-arrow');
    const enforcePwToggle = document.getElementById('enforce-password-requirements');
    if (arrow) {
        arrow.addEventListener('click', () => {
            const collapsible = document.getElementById('password-reqs-collapsible');
            togglePasswordReqs(collapsible.style.display === 'none');
        });
    }
    if (enforcePwToggle) {
        enforcePwToggle.addEventListener('change', (e) => togglePasswordReqs(e.target.checked));
    }
}

        // Load initial data from Supabase
        async function loadInitialData() {
             try {
                await Promise.all([
                    loadDepartments(),
                    loadQA(),
					loadUsers(),
                    loadSuggestions(),
					loadUserQuestions(),
					loadQALog(),
                    loadSettings()
                ]);
                updateDatalist();
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        async function loadDepartments() {
          const { data, error } = await supabaseClient.from('department_list').select('department_name');
          if (error) console.error('Error loading departments:', error);
          else {
            appState.departments = (data || []).map(d => d.department_name);
            renderDepartmentList();   
            updateDepartmentSelects(); 
          }
        }

        async function loadQA() {
            const { data, error } = await supabaseClient.from('qa').select('*');
            if (error) console.error('Error loading Q&A:', error);
            else {
                appState.qaData = data || [];
                precomputeTermFrequencies();
            }
        }

        async function loadSettings() {
            try {
                const { data, error } = await supabaseClient
                    .from('settings')
                    .select('*')
                    .eq('id', 1)
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    console.error('Error loading settings from database:', error);
                }
                
                if (data) {
                    appState.settings = data;
                    console.log('Settings loaded from database:', data);
                } else {
                    // Create default settings if none exist
                    console.log('No settings found, creating defaults');

const defaultSettings = {
    site_title: 'Tally SOP',
    allow_user_list: true,
    allow_password_reset: true,
    allow_suggestions: true,
    allow_media_visibility: true,
    enforce_password_requirements: true,
    enforce_pw_min_length: true,
    pw_min_length_value: 8,
    enforce_pw_uppercase: true,
    enforce_pw_lowercase: true,
    enforce_pw_number: true,
    enforce_pw_special: true
};
                    
                    // Save default settings to database
                    const { error: insertError } = await supabaseClient
                        .from('settings')
                        .insert([{ id: 1, ...defaultSettings }]);
                    
                    if (insertError) {
                        console.error('Error creating default settings:', insertError);
                    }
                    
                    appState.settings = defaultSettings;
                }
            } catch (error) {
                console.error('Exception loading settings:', error);
                // Fallback to defaults
                appState.settings = {
                    site_title: 'Tally SOP',
                    allow_user_list: true,
                    allow_password_reset: true,
                    allow_suggestions: true,
                    allow_media_visibility: true
                };
            }
        }

        // Load suggestions from database
        async function loadSuggestions() {
            try {
                const { data, error } = await supabaseClient
                    .from('suggestions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading suggestions:', error);
                    appState.suggestions = [];
                    return;
                }
                
                appState.suggestions = data || [];
                console.log('Loaded suggestions:', appState.suggestions.length);
            } catch (error) {
                console.error('Exception loading suggestions:', error);
                appState.suggestions = [];
            }
        }

        // --- Core Application Logic ---

        async function handleLogin(e) {
			e.preventDefault();
			const uid = document.getElementById('uid').value.trim();
			const password = document.getElementById('password').value.trim();
			const loginError = document.getElementById('login-error');
			loginError.textContent = '';

			if (!uid || !password) {
				loginError.textContent = 'Please enter both Username/UID and password';
				return;
			}

			try {
				// Step 1: Attempt to log in as an Admin using a case-insensitive search
				const { data: adminData, error: adminError } = await supabaseClient
					.from('admin_credentials')
					.select('user_id, password')
					.ilike('user_id', uid) // Use .ilike() for a case-insensitive match
					.single();

				// If an admin is found and the password matches...
				if (adminData && adminData.password === password) {
					// Store the correctly-cased user_id from the database
					appState.currentAdminUser = adminData.user_id; 
					appState.currentUserType = 'admin';
					showAdminPage();
					return; // Success, exit the function
				}

				// Step 2: If not an admin, attempt to log in as a User using a case-insensitive search
				const { data: userData, error: userError } = await supabaseClient
					.from('user_credentials')
					.select('user_id, password, department')
					.ilike('user_id', uid) // Use .ilike() for a case-insensitive match
					.single();

				// If a user is found and the password matches...
				if (userData && userData.password === password) {
					// Store the correctly-cased user_id from the database
					appState.currentUser = userData.user_id; 
					appState.currentUserType = 'user';
					showUserPage(userData.user_id); // Pass the correct user_id to the display function
					return; // Success, exit the function
				}
				
				// Step 3: If neither check was successful, show a generic error
				loginError.textContent = 'Invalid username or password';

			} catch (error) {
				// This catch block handles potential errors, such as network issues
				// or if multiple users match a case-insensitive search (e.g., 'user' and 'User' both exist).
				if (error && error.code === 'PGRST116') {
					 loginError.textContent = 'Invalid username or password'; // Treat multiple matches as invalid
				} else {
					console.error('Login exception:', error);
					loginError.textContent = 'An error occurred during login. Please try again.';
				}
			}
		}



       function showSection(sectionName) {
	    currentAdminSection = sectionName;
            document.querySelectorAll('.main-content > .content-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar .menu-item').forEach(mi => mi.classList.remove('active'));
            const section = document.getElementById(sectionName + '-section');
            const menuItem = document.querySelector(`.sidebar .menu-item[onclick="showSection('${sectionName}')"]`);
            if (section) section.classList.remove('hidden');
            if (menuItem) menuItem.classList.add('active');

            if (sectionName === 'qa') {
                setMode('ask');
            }

            if (sectionName === 'department') {
                renderDepartmentList();   
            }
            
            // Load and render user data when showing user management
            if (sectionName === 'user-management') {
                loadUsersAndRender();
            }

            // Load suggestions when showing report section
            if (sectionName === 'report') {
                loadSuggestionsAndRender();
            }

            // Load settings when showing settings section
            if (sectionName === 'settings') {
                loadAndDisplaySettings();
            }

            // Load admin data when showing change password section
            if (sectionName === 'change-password') {
                loadAdminList();
                setupPasswordValidation();
                updateCurrentAdminDisplay();
            }
        }

        // NEW: Combined function to load users and render the list
        async function loadUsersAndRender() {
            try {
                await loadUsers(); // Reload users from database
                renderUserList(); // Render the list
                updateUserDepartmentSelect(); // Update department dropdown
            } catch (error) {
                console.error('Error loading users:', error);
                // Show error message to user
                const errorDiv = document.getElementById('user-error');
                if (errorDiv) {
                    errorDiv.textContent = 'Error loading users. Please refresh the page.';
                    errorDiv.style.display = 'block';
                }
            }
        }
        
        function setMode(mode) {
    appState.currentMode = mode;
    const qaButtons = document.querySelectorAll('.qa-buttons .btn');
    const [askButton, addButton] = qaButtons;

    // Remove and add active class
    askButton.classList.remove('btn-active');
    addButton.classList.remove('btn-active');

    if (mode === 'ask') {
        askButton.classList.add('btn-active');
    } else if (mode === 'add') {
        addButton.classList.add('btn-active');
    }

    const adminControls = document.getElementById('admin-controls-section');
    const answerField = document.getElementById('admin-answer');
    const addModeDeptSelect = document.getElementById('add-mode-department-select'); // NEW

    adminControls.classList.toggle('hidden', mode !== 'add');
    answerField.readOnly = (mode === 'ask');
    
    // Show/hide department selection based on mode
    if (addModeDeptSelect) {
        addModeDeptSelect.classList.toggle('hidden', mode !== 'add');
    }

    if (mode === 'add') {
        clearQAFields();
        updateAddModeDepartmentSelect(); // NEW
        // Set default to "All Departments"
        const allCheckbox = document.querySelector('#add-department-checkbox input[value="all"]');
        if (allCheckbox) allCheckbox.checked = true;
        updateAddDeptButtonText(); // NEW
    } else {
        clearQAFields();
    }
}
// Update department select for Add mode
function updateAddModeDepartmentSelect() {
    const checkboxGroup = document.getElementById('add-department-checkbox');
    if (!checkboxGroup) return;
    checkboxGroup.innerHTML = '';
    checkboxGroup.appendChild(createAddDeptCheckbox('all', 'All Departments'));
    appState.departments.forEach(dept => {
        checkboxGroup.appendChild(createAddDeptCheckbox(dept, dept));
    });
}

function createAddDeptCheckbox(value, text) {
    const label = document.createElement('label');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = value;
    checkbox.onchange = handleAddDeptCheckboxChange;
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(' ' + text));
    return label;
}

function handleAddDeptCheckboxChange(event) {
    const changedCheckbox = event.target;
    const allCheckbox = document.querySelector('#add-department-checkbox input[value="all"]');
    
    if (changedCheckbox.value === 'all' && changedCheckbox.checked) {
        document.querySelectorAll('#add-department-checkbox input:not([value="all"])').forEach(cb => cb.checked = false);
    } else if (changedCheckbox.value !== 'all' && changedCheckbox.checked) {
        if (allCheckbox) allCheckbox.checked = false;
    }
    updateAddDeptButtonText();
}

function updateAddDeptButtonText() {
    const btn = document.getElementById('add-dept-dropdown-btn');
    const selected = document.querySelectorAll('#add-department-checkbox input:checked');
    if (selected.length === 0) {
        btn.textContent = 'All Departments';
    } else if (selected.length === 1 && selected[0].value === 'all') {
        btn.textContent = 'All Departments';
    } else if (selected.length === 1) {
        btn.textContent = selected[0].value;
    } else {
        btn.textContent = `${selected.length} Departments Selected`;
    }
}
		


// Replace the entire validatePasswordRealtime function
function validatePasswordRealtime() {
    const password = document.getElementById('new-password').value;
    const settings = appState.settings || {};

    // First, update which requirements are visible based on settings
    updatePasswordRequirementsUI();

    // If enforcement is off, don't show any checkmarks
    if (settings.enforce_password_requirements === false) {
        document.querySelectorAll('#password-requirements li').forEach(li => li.classList.remove('satisfied'));
        return;
    }

    // Check each requirement only if it's enabled in settings
    if (settings.enforce_pw_min_length) {
        const minLength = settings.pw_min_length_value || 8;
        document.getElementById('req-length').classList.toggle('satisfied', password.length >= minLength);
    }
    if (settings.enforce_pw_uppercase) {
        document.getElementById('req-uppercase').classList.toggle('satisfied', /[A-Z]/.test(password));
    }
    if (settings.enforce_pw_lowercase) {
        document.getElementById('req-lowercase').classList.toggle('satisfied', /[a-z]/.test(password));
    }
    if (settings.enforce_pw_number) {
        document.getElementById('req-number').classList.toggle('satisfied', /[0-9]/.test(password));
    }
    if (settings.enforce_pw_special) {
        document.getElementById('req-special').classList.toggle('satisfied', /[^A-Za-z0-9]/.test(password));
    }
}



        
        function handleQuestionInput() {
            const input = document.getElementById('admin-question').value.trim();
            const predictionContainer = document.getElementById('admin-prediction-list');
            if (3>input.length ) {
                if (predictionContainer) predictionContainer.style.display = 'none';
                return;
            }
            const predictions = findSimilarQuestions(input);
            displayPredictions(predictions);
        }

        function findSimilarQuestions(input) {
            const inputLower = input.toLowerCase();
            return appState.qaData.filter(qa => qa.question && qa.question.toLowerCase().includes(inputLower)).slice(0, 5);
        }

        function displayPredictions(predictions) {
            const container = document.getElementById('admin-prediction-list');
            if (!container) return;
            if (predictions.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.innerHTML = predictions.map(p => `<div class="prediction-item" onclick="selectPrediction('${p.id}')">${p.question}</div>`).join('');
            container.style.display = 'block';
        }


        // --- UPDATED selectPrediction function ---
        function selectPrediction(predictionId) {
			const prediction = appState.qaData.find(qa => qa.id == predictionId);
			if (!prediction) return;

			appState.currentQA = prediction;

			const questionField = document.getElementById('admin-question');
			const answerField = document.getElementById('admin-answer');
			const predictionList = document.getElementById('admin-prediction-list');

			if (questionField) {
				questionField.setAttribute('data-qa-id', prediction.id);
				questionField.value = prediction.question;
			}
			if (answerField) {
				answerField.value = prediction.answer || '';
			}
			if (predictionList) {
				predictionList.style.display = 'none';
			}

			// --- Safely handle 'Ask' mode preview ---
			const mediaPreviewContainer = document.getElementById('ask-mode-media-preview');
			const mediaContentDiv = document.getElementById('ask-media-content');
			const noMediaDiv = document.getElementById('ask-no-media');

			if (mediaContentDiv) mediaContentDiv.innerHTML = '';
			let hasMedia = false;

			if (prediction.video_url && mediaContentDiv) {
				mediaContentDiv.innerHTML += `<div class="media-preview-item"><strong>Video:</strong> <a href="${prediction.video_url}" target="_blank">View Video</a></div>`;
				hasMedia = true;
			}

			if (prediction.image_urls && mediaContentDiv) {
				mediaContentDiv.innerHTML += `<div class="media-preview-item"><strong>Images/PDFs:</strong> <a href="${prediction.image_urls.split(',')[0]}" target="_blank">View File</a></div>`;
				hasMedia = true;
			}

			if (mediaPreviewContainer) mediaPreviewContainer.classList.toggle('hidden', !hasMedia);
			if (noMediaDiv) noMediaDiv.classList.toggle('hidden', hasMedia);

			// --- Safely handle 'Add/Edit' mode controls ---
			const videoUrl = prediction.video_url;
			const videoUrlInput = document.getElementById('video-url-input');
			const videoPreviewLink = document.getElementById('video-preview-link');

			if (videoUrlInput) videoUrlInput.value = videoUrl || '';
			if (videoUrl) {
				if (videoPreviewLink) videoPreviewLink.href = videoUrl;
				showMediaState('video', 'filled');
			} else {
				showMediaState('video', 'empty');
			}

			const imageUrls = prediction.image_urls;
			const imagePreviewLink = document.getElementById('image-preview-link');
			if (imageUrls) {
				const firstUrl = imageUrls.split(',')[0];
				if (imagePreviewLink) imagePreviewLink.href = firstUrl;
				showMediaState('image', 'filled');
			} else {
				showMediaState('image', 'empty');
			}
			
			// Change the button text to indicate we are in "update" mode
			const saveBtn = document.getElementById('save-qa-btn');
			if (saveBtn) {
				saveBtn.textContent = 'Update';
			}
	
		}

        // --- NEW/UPDATED Media handling functions ---
        
        function loadMediaForAdmin(qaItem) {
            const videoInput = document.getElementById('video-link');
            const videoEditor = document.getElementById('video-link-editor');
            const imageDisplay = document.getElementById('current-images-display');

            // Video: fill input + editable textarea
            const url = (qaItem && qaItem.video_url) ? qaItem.video_url : '';
            if (videoInput) videoInput.value = url;
            if (videoEditor) {
                videoEditor.value = url;
                videoEditor.style.display = 'block';
            }

            // Clickable preview link (opens in new tab)
            let preview = document.getElementById('video-preview-link');
            if (url) {
                if (!preview) {
                    preview = document.createElement('a');
                    preview.id = 'video-preview-link';
                    preview.textContent = 'Open Video';
                    preview.style.display = 'inline-block';
                    preview.style.marginTop = '8px';
                    preview.style.color = '#007bff';
                    preview.style.cursor = 'pointer';
                    if (videoEditor) {
                        videoEditor.insertAdjacentElement('afterend', preview);
                    } else if (videoInput) {
                        videoInput.insertAdjacentElement('afterend', preview);
                    }
                }
                preview.href = url;
                preview.target = '_blank';
            } else if (preview) {
                preview.remove();
            }

           // Files (image/pdf) from DB
            const imgLink = document.getElementById('image-preview-link');
            const previewEl = document.getElementById('file-preview');
            currentFileUrl = null;
            currentFileMime = null;

            // Reset previous preview
            if (previewEl) previewEl.innerHTML = '';

            if (qaItem && qaItem.image_urls) {
              const urls = qaItem.image_urls.split(',').map(s => s.trim()).filter(Boolean);
              const firstRaw = urls[0] || '';

              // Show raw list
              imageDisplay.innerHTML = `<strong>Current Images:</strong> ${qaItem.image_urls}`;
              imageDisplay.style.display = 'block';

              // If it's already a URL, use it; otherwise build from IMAGE_BASE_URL
              let firstUrl;
              const alreadyUrl = /^https?:\/\//i.test(firstRaw) || /^file:\/\//i.test(firstRaw);
              if (alreadyUrl) {
                firstUrl = firstRaw;
              } else if (IMAGE_BASE_URL) {
                firstUrl = joinPublicUrl(IMAGE_BASE_URL, firstRaw); // convert filename -> full URL
              }

              if (firstUrl) {
                currentFileUrl = firstUrl;
                const lower = firstUrl.toLowerCase();
                currentFileMime = lower.endsWith('.pdf') ? 'application/pdf' : 'image/*';
                if (imgLink) { imgLink.href = firstUrl; imgLink.style.display = 'inline-block'; }
                renderPreviewFromUrl(firstUrl, currentFileMime); // show inline preview
              } else if (imgLink) {
                imgLink.removeAttribute('href');
                imgLink.style.display = 'none';
              }
            } else {
              imageDisplay.innerHTML = '';
              imageDisplay.style.display = 'none';
              if (imgLink) { imgLink.removeAttribute('href'); imgLink.style.display = 'none'; }
            }
        }
        
        // Get normalized image URLs for a QA row
        function normalizeImageList(image_urls) {
          if (!image_urls) return [];
          return image_urls
            .split(',')
            .map(s => s.trim())
            .filter(Boolean)
            .map(u => {
              const isUrl = /^https?:\/\//i.test(u) || /^file:\/\//i.test(u);
              return isUrl ? u : joinPublicUrl(IMAGE_BASE_URL, u);
            });
        }

        // Fetch images by QA id
        async function fetchImagesById(qaId) {
          const { data, error } = await supabaseClient
            .from('qa')
            .select('image_urls')
            .eq('id', qaId)
            .single();
          if (error || !data) return [];
          return normalizeImageList(data.image_urls);
        }

        // OR fetch images by exact question text
        async function fetchImagesByQuestion(questionText) {
          const { data, error } = await supabaseClient
            .from('qa')
            .select('image_urls')
            .eq('question', questionText)
            .maybeSingle();
          if (error || !data) return [];
          return normalizeImageList(data.image_urls);
        }

        function renderPreviewFromUrl(url, mime) {
          const preview = document.getElementById('file-preview');
          if (!preview) return;
          preview.innerHTML = '';

          if (mime === 'application/pdf' || url.toLowerCase().endsWith('.pdf')) {
            // PDF inline
            const frame = document.createElement('iframe');
            frame.src = url;
            frame.width = '100%';
            frame.height = '300';
            frame.style.border = '1px solid #dee2e6';
            preview.appendChild(frame);
          } else {
            // Image inline
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Preview';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '300px';
            img.style.border = '1px solid #dee2e6';
            img.style.borderRadius = '6px';
            preview.appendChild(img);
          }
        }

        function renderPreviewFromFile(file, url) {
          const preview = document.getElementById('file-preview');
          if (!preview) return;
          preview.innerHTML = '';

          if (file.type === 'application/pdf') {
            const frame = document.createElement('iframe');
            frame.src = url;
            frame.width = '100%';
            frame.height = '300';
            frame.style.border = '1px solid #dee2e6';
            preview.appendChild(frame);
          } else if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = url;
            img.alt = file.name;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '300px';
            img.style.border = '1px solid #dee2e6';
            img.style.borderRadius = '6px';
            preview.appendChild(img);
          }
        }

        function addVideo() {
            const videoInput = document.getElementById('video-link');
            const videoEditor = document.getElementById('video-link-editor');

            if (videoEditor && !videoEditor.value && videoInput && videoInput.value) {
                videoEditor.value = videoInput.value;
            }
            if (videoEditor) {
                videoEditor.style.display = 'block';
                videoEditor.focus();
            }
            if (videoInput) {
                videoInput.style.display = 'block';
            }
        }

        function addImage() {
          const upload = document.getElementById('image-upload');

          if (currentFileUrl) {
            const mime = currentFileMime || (currentFileUrl.toLowerCase().endsWith('.pdf') ? 'application/pdf' : 'image/*');
            renderPreviewFromUrl(currentFileUrl, mime); // show inline preview
            // window.open(currentFileUrl, '_blank'); // optional: also open new tab
          } else {
            alert("No file to preview for this question. Choose an image or PDF.");
            if (upload) { upload.style.display = 'block'; /* upload.click(); */ }
          }
        }
        
        // --- Department Dropdown Functions ---
        
        function updateDepartmentSelects() {
            const checkboxGroup = document.getElementById('qa-department-checkbox');
            if (!checkboxGroup) return;
            checkboxGroup.innerHTML = '';
            checkboxGroup.appendChild(createDeptCheckbox('all', 'All Departments'));
            appState.departments.forEach(dept => {
                checkboxGroup.appendChild(createDeptCheckbox(dept, dept));
            });
        }
		
		// This function shows or hides the eye icon based on input content
		function handlePasswordInput(inputElement) {
			// Find the parent wrapper div first
			const wrapper = inputElement.parentElement;
			if (!wrapper) return;

			// Now find the icon INSIDE the wrapper
			const icon = wrapper.querySelector('.password-toggle-icon');
			if (!icon) return;
			
			// If the input has any text, display the icon, otherwise hide it
			if (inputElement.value.length > 0) {
				icon.style.display = 'block';
			} else {
				icon.style.display = 'none';
			}
		}
				
        function createDeptCheckbox(value, text) {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = value;
            checkbox.onchange = handleDeptCheckboxChange;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + text));
            return label;
        }

        function handleDeptCheckboxChange(event) {
            const changedCheckbox = event.target;
            const allCheckbox = document.querySelector('#qa-department-checkbox input[value="all"]');
            if (changedCheckbox.value === 'all' && changedCheckbox.checked) {
                document.querySelectorAll('#qa-department-checkbox input:not([value="all"])').forEach(cb => cb.checked = false);
            } else if (changedCheckbox.value !== 'all' && changedCheckbox.checked) {
                if (allCheckbox) allCheckbox.checked = false;
            }
            updateDeptButtonText();
        }
        
        function updateDeptButtonText() {
            const btn = document.getElementById('dept-dropdown-btn');
            const selected = document.querySelectorAll('#qa-department-checkbox input:checked');
            if (selected.length === 0) btn.textContent = 'Select Departments';
            else if (selected.length === 1 && selected[0].value === 'all') btn.textContent = 'All Departments';
            else if (selected.length === 1) btn.textContent = selected[0].value;
            else btn.textContent = `${selected.length} Departments Selected`;
        }

        function checkDepartmentsForQuestion(qaItem) {
            const departments = qaItem.departments || '';
            const deptArray = departments.split(',').map(d => d.trim());
            document.querySelectorAll('#qa-department-checkbox input').forEach(cb => {
                cb.checked = deptArray.includes(cb.value);
            });
            updateDeptButtonText();
        }
        
        

        
        async function handleSaveOrUpdateQA() {
    const qaId = appState.currentQA ? appState.currentQA.id : null;
    const question = document.getElementById('admin-question').value.trim();
    const answer = document.getElementById('admin-answer').value.trim();
    
    // Get selected departments from Add mode selection
    let selectedDepartments = [];
    if (appState.currentMode === 'add') {
        const selectedCheckboxes = document.querySelectorAll('#add-department-checkbox input:checked');
        selectedDepartments = Array.from(selectedCheckboxes).map(cb => cb.value);
    } else {
        // For ask/edit mode, use existing logic
        const selectedCheckboxes = document.querySelectorAll('#qa-department-checkbox input:checked');
        selectedDepartments = Array.from(selectedCheckboxes).map(cb => cb.value);
    }
    
    const videoUrlInput = document.getElementById('video-url-input');
    const imageUploadInput = document.getElementById('image-upload-input');

    // Validation
    if (!question || !answer) {
        showQAStatus('Please fill question and answer.', 'error');
        return;
    }

    // If no departments selected, default to 'all'
    const departmentsString = selectedDepartments.length === 0 || selectedDepartments.includes('all') 
        ? 'all' 
        : selectedDepartments.join(',');

    const qaData = {
        question,
        answer,
        departments: departmentsString,
        video_url: videoUrlInput ? videoUrlInput.value.trim() : null,
        image_urls: (imageUploadInput && imageUploadInput.files.length > 0) 
            ? Array.from(imageUploadInput.files).map(f => f.name).join(',') 
            : (appState.currentQA ? appState.currentQA.image_urls : null)
    };

    // Rest of the save logic remains the same...
    try {
        let error;
        if (qaId) {
            const { error: updateError } = await supabaseClient
                .from('qa')
                .update(qaData)
                .eq('id', qaId);
            error = updateError;
        } else {
            const { error: insertError } = await supabaseClient
                .from('qa')
                .insert([qaData]);
            error = insertError;
        }

        if (error) {
            showQAStatus(`Error: ${error.message}`, 'error');
        } else {
            showQAStatus(`Q&A ${qaId ? 'updated' : 'saved'} successfully!`, 'success');
            await loadQA();
            clearQAFields();
        }
    } catch (err) {
        console.error("Save/Update Exception:", err);
        showQAStatus('An unexpected error occurred.', 'error');
    }
}



        
        function clearQAFields() {
            const q = document.getElementById('admin-question');
            if (q) { q.value = ''; q.removeAttribute('data-qa-id'); }

            const a = document.getElementById('admin-answer');
            if (a) a.value = '';

            const pred = document.getElementById('admin-prediction-list');
            if (pred) pred.style.display = 'none';

            const vi = document.getElementById('video-link');
            if (vi) vi.value = '';

            const ve = document.getElementById('video-link-editor');
            if (ve) { ve.value = ''; ve.style.display = 'none'; }

            const vlink = document.getElementById('video-preview-link');
            if (vlink) vlink.remove();

            const imgUp = document.getElementById('image-upload');
            if (imgUp) imgUp.value = '';

            const imgDisp = document.getElementById('current-images-display');
            currentFileUrl = null;
            currentFileMime = null;
            if (fileObjectURL) { URL.revokeObjectURL(fileObjectURL); fileObjectURL = null; }

            const imgLink = document.getElementById('image-preview-link');
            if (imgLink) { imgLink.removeAttribute('href'); imgLink.style.display = 'none'; }
            const prev = document.getElementById('file-preview');
            if (prev) prev.innerHTML = '';
			
			// Reset the state to indicate we are creating a new entry
			appState.currentQA = null;

			// Change the button text back to "Save"
			const saveBtn = document.getElementById('save-qa-btn');
			if (saveBtn) {
				saveBtn.textContent = 'Save';
			}
			if (appState.currentMode === 'add') {
        document.querySelectorAll('#add-department-checkbox input').forEach(cb => cb.checked = false);
        const allCheckbox = document.querySelector('#add-department-checkbox input[value="all"]');
        if (allCheckbox) allCheckbox.checked = true;
        updateAddDeptButtonText();
    }
			
			// Inside clearQAFields()
			document.getElementById('video-added-feedback').classList.add('hidden');
			document.getElementById('image-added-feedback').classList.add('hidden');

        }

        // --- Department Management Functions ---
        function renderDepartmentList() {
          const box = document.getElementById('dept-list');
          const empty = document.getElementById('dept-list-empty');
          if (!box) return;

          const list = (appState.departments || []).slice().sort((a,b)=>a.localeCompare(b));

          if (list.length === 0) {
            if (empty) empty.style.display = 'block';
            box.innerHTML = '';
            return;
          } else {
            if (empty) empty.style.display = 'none';
          }

          box.innerHTML = list.map(name => `
            <label style="display:flex; align-items:center; gap:8px; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px;">
              <input type="checkbox" class="dept-item" value="${name}">
              <span style="flex:1;">${name}</span>
            </label>
          `).join('');
        }

        // Updated deleteDepartments function with confirmation modal
        async function deleteDepartments() {
            const checks = Array.from(document.querySelectorAll('#dept-list .dept-item:checked'));
            if (checks.length === 0) {
                alert('Please select at least one department to delete.');
                return;
            }
            
            // Store the departments to be deleted
            departmentsToDelete = checks.map(cb => cb.value);
            
            // Show the confirmation modal
            showDeleteConfirmationModal(departmentsToDelete);
        }

        // Function to show the delete confirmation modal
        function showDeleteConfirmationModal(departments) {
            const modal = document.getElementById('delete-confirmation-modal');
            const departmentsList = document.getElementById('departments-to-delete');
            const confirmInput = document.getElementById('delete-confirmation-input');
            const deleteBtn = document.getElementById('confirm-delete-btn');
            
            // Populate the departments list
            departmentsList.innerHTML = departments.map(dept => 
                `<div class="department-item">${dept}</div>`
            ).join('');
            
            // Reset the input and button state
            confirmInput.value = '';
            confirmInput.classList.remove('valid');
            deleteBtn.classList.remove('enabled');
            deleteBtn.disabled = true;
            
            // Show the modal
            modal.style.display = 'flex';
            
            // Focus on the input
            setTimeout(() => {
                confirmInput.focus();
            }, 100);
        }

        // Function to handle confirmation input changes
        function setupDeleteConfirmationInput() {
            const confirmInput = document.getElementById('delete-confirmation-input');
            const deleteBtn = document.getElementById('confirm-delete-btn');
            
            if (confirmInput && deleteBtn) {
                confirmInput.addEventListener('input', function() {
                    const inputValue = this.value;
                    
                    if (inputValue === 'DELETE') {
                        this.classList.add('valid');
                        deleteBtn.classList.add('enabled');
                        deleteBtn.disabled = false;
                    } else {
                        this.classList.remove('valid');
                        deleteBtn.classList.remove('enabled');
                        deleteBtn.disabled = true;
                    }
                });
                
                // Allow Enter key to trigger deletion if input is valid
                confirmInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.value === 'DELETE') {
                        confirmDepartmentDeletion();
                    }
                });
            }
        }

        // Function to cancel department deletion
        function cancelDepartmentDeletion() {
            const modal = document.getElementById('delete-confirmation-modal');
            modal.style.display = 'none';
            departmentsToDelete = [];
        }

        // Function to confirm and proceed with department deletion
        async function confirmDepartmentDeletion() {
            const confirmInput = document.getElementById('delete-confirmation-input');
            
            if (confirmInput.value !== 'DELETE') {
                alert('Please type DELETE exactly as shown to confirm deletion.');
                return;
            }
            
            if (departmentsToDelete.length === 0) {
                alert('No departments selected for deletion.');
                return;
            }
            
            try {
                // Hide the modal first
                const modal = document.getElementById('delete-confirmation-modal');
                modal.style.display = 'none';
                
                // Delete from DB (department_name must be unique)
                const { error } = await supabaseClient
                    .from('department_list')
                    .delete()
                    .in('department_name', departmentsToDelete);

                if (error) {
                    alert('Error deleting departments: ' + error.message);
                    return;
                }

                // Update local state
                appState.departments = appState.departments.filter(d => !departmentsToDelete.includes(d));

                // Show success message
                const successMsg = document.getElementById('dept-success');
                if (successMsg) {
                    successMsg.textContent = `${departmentsToDelete.length === 1 ? 'Department' : 'Departments'} deleted successfully`;
                    successMsg.style.display = 'block';
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                }

                // Refresh UI
                renderDepartmentList();
                updateDepartmentSelects(); // refresh Admin → Select Department(s)
                updateDeptButtonText();
                
                // Clear the departments to delete
                departmentsToDelete = [];
                
            } catch (error) {
                console.error('Error during department deletion:', error);
                alert('An unexpected error occurred while deleting departments.');
            }
        }

        // Function to close modal when clicking outside
        function setupModalCloseOnOutsideClick() {
            const modals = document.querySelectorAll('.modal-overlay');
            
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        if (modal.id === 'delete-confirmation-modal') {
                           cancelDepartmentDeletion();
                        } else if (modal.id === 'delete-user-confirmation-modal') {
                            cancelUserDeletion();
                        }
                    }
                });
            });
        }

        async function createDepartment() {
          const input = document.getElementById('new-dept-name');
          const err = document.getElementById('dept-error');
          const successMsg = document.getElementById('dept-success');
          if (!input) return;
          const name = (input.value || '').trim();

          // reset error and success messages
          if (err) { err.style.display='none'; err.textContent=''; }
          if (successMsg) { successMsg.style.display='none'; successMsg.textContent=''; }

          if (!name) {
            if (err) { err.textContent = 'Please enter a department name.'; err.style.display='block'; }
            return;
          }

          // prevent duplicates (case-insensitive)
          const exists = appState.departments.some(d => d.toLowerCase() === name.toLowerCase());
          if (exists) {
            if (err) { err.textContent = 'This department already exists.'; err.style.display='block'; }
            return;
          }

          // save to DB
          const { error } = await supabaseClient
            .from('department_list')
            .insert([{ department_name: name }]);

          if (error) {
            if (err) { err.textContent = 'Error creating department: ' + error.message; err.style.display='block'; }
            return;
          }

          // update local state + UI
          appState.departments.push(name);
          input.value = '';
          
          // Show success message
          if (successMsg) {
            successMsg.textContent = 'Department created successfully';
            successMsg.style.display = 'block';
            
            // Hide success message after 3 seconds
            setTimeout(() => {
              successMsg.style.display = 'none';
            }, 3000);
          }
          
          renderDepartmentList();
          updateDepartmentSelects();  // refresh checkboxes in Admin → Add
          updateDeptButtonText();     // refresh button text if needed
        }

        function logout() {
            window.location.reload();
	    document.getElementById('chatbot-container').style.display = 'none';
        }
        
        // FIXED: Excel Import Function
        async function importFromExcel() {
            const fileInput = document.getElementById('excel-upload');
            const statusDiv = document.getElementById('excel-status');
            
            // Reset status message
            if (statusDiv) {
                statusDiv.style.display = 'none';
                statusDiv.textContent = '';
            }
            
            // Check if file is selected
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showExcelStatus('Please select an Excel file first.', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file type
            const validTypes = ['.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!validTypes.includes(fileExtension)) {
                showExcelStatus('Please select a valid Excel file (.xlsx or .xls).', 'error');
                return;
            }
            
            try {
                showExcelStatus('Processing Excel file...', 'loading');
                
                // Read the Excel file
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Get the first worksheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    showExcelStatus('Excel file is empty or has no valid data.', 'error');
                    return;
                }
                
                // Process and validate the data
                const qaItems = [];
                let errorCount = 0;
                
                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    // Expected columns: question, answer, departments (optional: video_url, image_urls)
                    const question = (row.question || row.Question || '').toString().trim();
                    const answer = (row.answer || row.Answer || '').toString().trim();
                    const departments = (row.departments || row.Departments || 'all').toString().trim();
                    const video_url = (row.video_url || row['Video URL'] || '').toString().trim() || null;
                    const image_urls = (row.image_urls || row['Image URLs'] || '').toString().trim() || null;
                    
                    // Validate required fields
                    if (!question || !answer) {
                        console.warn(`Row ${i + 2}: Missing question or answer`);
                        errorCount++;
                        continue;
                    }
                    
                    qaItems.push({
                        question,
                        answer,
                        departments,
                        video_url,
                        image_urls
                    });
                }
                
                if (qaItems.length === 0) {
                    showExcelStatus('No valid Q&A records found in Excel file.', 'error');
                    return;
                }
                
                // Insert data into database
                showExcelStatus(`Uploading ${qaItems.length} records to database...`, 'loading');
                
                const { data, error } = await supabaseClient
                    .from('qa')
                    .insert(qaItems);
                
                if (error) {
                    console.error('Database error:', error);
                    showExcelStatus(`Database error: ${error.message}`, 'error');
                    return;
                }
                
                // Success!
                const successMsg = `Successfully imported ${qaItems.length} Q&A records`;
                const warningMsg = errorCount >0 ? ` (${errorCount} rows skipped due to missing data)` : '';
                showExcelStatus(successMsg + warningMsg, 'success');
                
                // Reload Q&A data and clear the file input
                await loadQA();
                fileInput.value = '';
                
            } catch (error) {
                console.error('Import error:', error);
                showExcelStatus(`Error processing file: ${error.message}`, 'error');
            }
        }
        
        // Helper function to show Q&A operation status messages
        function showQAStatus(message, type = 'info') {
            const statusDiv = document.getElementById('qa-status');
            if (!statusDiv) return;
            
            if (type === 'clear') {
                statusDiv.style.display = 'none';
                statusDiv.textContent = '';
                return;
            }
            
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Set color based on type
            switch (type) {
                case 'success':
                    statusDiv.style.color = '#28a745'; // Green
                    break;
                case 'error':
                    statusDiv.style.color = '#dc3545'; // Red
                    break;
                default:
                    statusDiv.style.color = '#6c757d'; // Gray
            }
            
            // Auto-hide success messages after 4 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (statusDiv) statusDiv.style.display = 'none';
                }, 4000);
            }
        }

        // Helper function to show Excel import status messages
        function showExcelStatus(message, type = 'info') {
            const statusDiv = document.getElementById('excel-status');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Set color based on type
            switch (type) {
                case 'success':
                    statusDiv.style.color = '#28a745'; // Green
                    break;
                case 'error':
                    statusDiv.style.color = '#dc3545'; // Red
                    break;
                case 'loading':
                    statusDiv.style.color = '#007bff'; // Blue
                    break;
                default:
                    statusDiv.style.color = '#6c757d'; // Gray
            }
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (statusDiv) statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // --- USER MANAGEMENT FUNCTIONS ---
        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_credentials')
                    .select('*')
                    .order('user_id');
                
                if (error) {
                    console.error('Error loading users:', error);
                    appState.users = []; // Set empty array on error
                    return;
                }
                
                appState.users = data || [];
            } catch (error) {
                console.error('Exception loading users:', error);
                appState.users = []; // Set empty array on exception
            }
        }

        function updateDatalist() {
            const datalist = document.getElementById('user-list-datalist');
            if(!datalist) return;

            const allowList = getSetting('allow_user_list', true);
            console.log('Allow user list setting:', allowList);
            if (!allowList) {
                datalist.innerHTML = '';
                return;
            }

            datalist.innerHTML = (appState.users || [])
                .map(user => `<option value="${user.user_id}"></option>`)
                .join('');
        }
		
		function togglePasswordVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function renderUserList() {
            const box = document.getElementById('user-list-box');
            const empty = document.getElementById('user-list-empty');
            
            if (!box) {
                console.error('user-list-box element not found');
                return;
            }

            const list = (appState.users || []).slice().sort((a,b) => {
                const aId = a.user_id || '';
                const bId = b.user_id || '';
                return aId.localeCompare(bId);
            });

            if (list.length === 0) {
                if (empty) empty.style.display = 'block';
                box.innerHTML = '';
                return;
            } else {
                if (empty) empty.style.display = 'none';
            }

            box.innerHTML = list.map(user => {
                const userId = user.user_id || 'Unknown';
                const department = user.department || 'No department';
                
                return `
                    <label style="display:flex; align-items:center; gap:8px; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; margin-bottom: 8px;">
                        <input type="checkbox" class="user-item" value="${userId}">
                        <span style="flex:1; font-weight:600;">${userId}</span>
                        <span style="color:#666; font-size:12px;">${department}</span>
                    </label>
                `;
            }).join('');
        }
		
		// Shows the correct state (empty or filled) for a media type
    function showMediaState(type, state) {
        const emptyState = document.getElementById(`${type}-empty-state`);
        const filledState = document.getElementById(`${type}-filled-state`);
        const input = document.getElementById(`${type === 'video' ? 'video-url-input' : 'image-upload-input'}`);

        if (state === 'filled') {
            emptyState.classList.add('hidden');
            filledState.classList.remove('hidden');
            input.classList.add('hidden');
        } else { // empty
            emptyState.classList.remove('hidden');
            filledState.classList.add('hidden');
            input.classList.add('hidden'); // Input is hidden by default
        }
    }

// This function reveals the hidden input field
        function addMedia(type) {
            if (type === 'image') {
                // Find the hidden input and trigger a click
                document.getElementById('image-upload-input').click();
            } else if (type === 'video') {
                const input = document.getElementById('video-url-input');
                input.classList.remove('hidden');
                input.focus();
            }
        }

    // Handles 'Change' button clicks
    function changeMedia(type) {
        const input = document.getElementById(`${type === 'video' ? 'video-url-input' : 'image-upload-input'}`);
        input.classList.remove('hidden');
        if (type === 'video') {
            input.focus();
        } else {
            input.click(); // Open file dialog for images
        }
    }

    // Handles 'Remove' button clicks
    function removeMedia(type) {
        if (!confirm(`Are you sure you want to remove the ${type}? This will be saved when you click 'Edit & Update'.`)) {
            return;
        }
        // To remove media, we just clear the input and show the empty state.
        // The save/update function will see the empty input and save it as null.
        if (type === 'video') {
            document.getElementById('video-url-input').value = '';
        } else {
            document.getElementById('image-upload-input').value = ''; // Clear file selection
        }
        showMediaState(type, 'empty');
    }

        async function createUser() {
            const uidInput = document.getElementById('new-user-uid');
            const passwordInput = document.getElementById('new-user-password');
            const err = document.getElementById('user-error');
            const successMsg = document.getElementById('user-success');
            
            if (!uidInput || !passwordInput) {
                console.error('Required input elements not found');
                return;
            }
			
            	
            const user_id = (uidInput.value || '').trim();
            const password = (passwordInput.value || '').trim();
            const selectedCheckboxes = document.querySelectorAll('#user-department-checkbox input:checked');
            const selectedDepartments = Array.from(selectedCheckboxes).map(cb => cb.value);
			
			const passwordValidation = validatePassword(password);
			if (!passwordValidation.isValid) {
				const err = document.getElementById('user-error');
				if (err) { 
					err.textContent = passwordValidation.message;
					err.style.display = 'block'; 
				}
				return;
			}

            // Reset error and success messages
            if (err) { err.style.display='none'; err.textContent=''; }
            if (successMsg) { successMsg.style.display='none'; successMsg.textContent=''; }

            // Validation
            if (!user_id) {
                if (err) { err.textContent = 'Please enter a User ID.'; err.style.display='block'; }
                return;
            }

            if (!password) {
                if (err) { err.textContent = 'Please enter a password.'; err.style.display='block'; }
                return;
            }

            if (selectedDepartments.length === 0) {
                if (err) { err.textContent = 'Please select at least one department.'; err.style.display='block'; }
                return;
            }

            // Check for duplicate user_id (case-insensitive)
            const exists = appState.users.some(u => u.user_id && u.user_id.toLowerCase() === user_id.toLowerCase());
            if (exists) {
                if (err) { err.textContent = 'This User ID already exists.'; err.style.display='block'; }
                return;
            }

            try {
                // Save to DB
                const departmentsString = selectedDepartments.join(',');
                const { data, error } = await supabaseClient
                    .from('user_credentials')
                    .insert([{ 
                        user_id: user_id, 
                        password: password, // Note: In production, hash the password!
                        department: departmentsString 
                    }])
                    .select(); // Get the inserted data back

                if (error) {
                    if (err) { err.textContent = 'Error creating user: ' + error.message; err.style.display='block'; }
                    return;
                }

                // Clear form
                uidInput.value = '';
                passwordInput.value = '';
                
                // Clear department selection
                document.querySelectorAll('#user-department-checkbox input:checked').forEach(cb => cb.checked = false);
                updateUserDeptButtonText();
                
                // Show success message
                if (successMsg) {
                    successMsg.textContent = 'User created successfully';
                    successMsg.style.display = 'block';
                    
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                }
                
                // Reload and render user list
                await loadUsersAndRender();
                
            } catch (error) {
                console.error('Exception creating user:', error);
                if (err) { err.textContent = 'Unexpected error creating user.'; err.style.display='block'; }
            }
        }

        // --- NEW USER DELETION FLOW ---
        
        async function deleteUsers() {
            const checks = Array.from(document.querySelectorAll('#user-list-box .user-item:checked'));
            if (checks.length === 0) {
                alert('Please select at least one user to delete.');
                return;
            }
            
            usersToDelete = checks.map(cb => cb.value);
            showDeleteUserConfirmationModal(usersToDelete);
        }

        function showDeleteUserConfirmationModal(userIds) {
            const modal = document.getElementById('delete-user-confirmation-modal');
            const usersListDiv = document.getElementById('users-to-delete');
            const confirmInput = document.getElementById('delete-user-confirmation-input');
            const deleteBtn = document.getElementById('confirm-user-delete-btn');
            
            usersListDiv.innerHTML = userIds.map(id => `<div class="department-item">${id}</div>`).join('');
            
            confirmInput.value = '';
            confirmInput.classList.remove('valid');
            deleteBtn.classList.remove('enabled');
            deleteBtn.disabled = true;
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
                confirmInput.focus();
            }, 100);
        }

        function setupUserDeleteConfirmationInput() {
            const confirmInput = document.getElementById('delete-user-confirmation-input');
            const deleteBtn = document.getElementById('confirm-user-delete-btn');
            
            if (confirmInput && deleteBtn) {
                confirmInput.addEventListener('input', function() {
                    if (this.value === 'DELETE') {
                        this.classList.add('valid');
                        deleteBtn.classList.add('enabled');
                        deleteBtn.disabled = false;
                    } else {
                        this.classList.remove('valid');
                        deleteBtn.classList.remove('enabled');
                        deleteBtn.disabled = true;
                    }
                });
                
                confirmInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.value === 'DELETE') {
                        confirmUserDeletion();
                    }
                });
            }
        }

        function cancelUserDeletion() {
            const modal = document.getElementById('delete-user-confirmation-modal');
            modal.style.display = 'none';
            usersToDelete = [];
        }

        async function confirmUserDeletion() {
            if (usersToDelete.length === 0) {
                alert('No users selected for deletion.');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('user_credentials')
                    .delete()
                    .in('user_id', usersToDelete);

                if (error) {
                    alert('Error deleting users: ' + error.message);
                    return;
                }

                const successMsg = document.getElementById('user-success');
                if (successMsg) {
                    successMsg.textContent = `${usersToDelete.length === 1 ? 'User' : 'Users'} deleted successfully`;
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                }

                await loadUsersAndRender(); // Reload and re-render the list
                cancelUserDeletion(); // Hide modal and clear the array
                
            } catch (error) {
                console.error('Exception during user deletion:', error);
                alert('An unexpected error occurred while deleting users.');
            }
        }


        // Function to setup user management event listeners
        function setupUserEventListeners() {
            const userQuestionInput = document.getElementById('user-question');
            userQuestionInput.addEventListener('input', handleUserQuestionInput);
            userQuestionInput.addEventListener('blur', () => setTimeout(() => {
                document.getElementById('user-prediction-list').style.display = 'none';
            }, 200));
            // User management event listeners
            const userDeptDropdownBtn = document.getElementById('user-dept-dropdown-btn');
            const userDeptCheckboxPanel = document.getElementById('user-department-checkbox');
            
            if (userDeptDropdownBtn && userDeptCheckboxPanel) {
                userDeptDropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDeptCheckboxPanel.classList.toggle('hidden');
                });

                document.addEventListener('click', (event) => {
                    if (!userDeptDropdownBtn.contains(event.target) && !userDeptCheckboxPanel.contains(event.target)) {
                        userDeptCheckboxPanel.classList.add('hidden');
                    }
                });
            }

            const createUserBtn = document.getElementById('create-user-btn');
            const newUserUid = document.getElementById('new-user-uid');
            const newUserPassword = document.getElementById('new-user-password');
            const deleteUserBtn = document.getElementById('delete-user-btn');
            
            if (createUserBtn) {
                createUserBtn.removeEventListener('click', createUser);
                createUserBtn.addEventListener('click', createUser);
            }
            
            if (newUserUid) {
                newUserUid.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const passwordField = document.getElementById('new-user-password');
                        if (passwordField) passwordField.focus();
                    }
                });
            }

            if (newUserPassword) {
                newUserPassword.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        createUser();
                    }
                });
            }
            
            if (deleteUserBtn) {
                deleteUserBtn.removeEventListener('click', deleteUsers);
                deleteUserBtn.addEventListener('click', deleteUsers);
            }
        }

        function updateUserDepartmentSelect() {
            const checkboxGroup = document.getElementById('user-department-checkbox');
            if (!checkboxGroup) return;
            checkboxGroup.innerHTML = '';
            
            appState.departments.forEach(dept => {
                checkboxGroup.appendChild(createUserDeptCheckbox(dept, dept));
            });
        }

        function createUserDeptCheckbox(value, text) {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = value;
            checkbox.onchange = handleUserDeptCheckboxChange;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + text));
            return label;
        }

        function handleUserDeptCheckboxChange(event) {
            updateUserDeptButtonText();
        }

        function updateUserDeptButtonText() {
            const btn = document.getElementById('user-dept-dropdown-btn');
            const selected = document.querySelectorAll('#user-department-checkbox input:checked');
            if (selected.length === 0) {
                btn.textContent = 'Select Department';
            } else if (selected.length === 1) {
                btn.textContent = selected[0].value;
            } else {
                btn.textContent = `${selected.length} Departments Selected`;
            }
        }

        // --- SUGGESTIONS REPORT FUNCTIONS ---
        
        // Load suggestions and render the report
        async function loadSuggestionsAndRender() {
            try {
                await loadSuggestions();
				 await loadUserQuestions();
				 await loadQALog();
                showReport('suggestions'); // Show suggestions report by default
                renderSuggestionsTable();
            } catch (error) {
                console.error('Error loading suggestions report:', error);
            }
        }

        // Show specific report tab
        function showReport(reportType) {
            // Update active tab
             document.querySelectorAll('.report-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.report-tab[onclick="showReport('${reportType}')"]`).classList.add('active');
    
    // Show/hide report content
    document.querySelectorAll('.report-content').forEach(content => content.classList.add('hidden'));
    document.getElementById(`${reportType}-report`).classList.remove('hidden');
    
    appState.currentReport = reportType;
    
    if (reportType === 'suggestions') {
        renderSuggestionsTable();
        setupSuggestionsFilter();
    } else if (reportType === 'user-questions') {
        renderUserQuestionsTable();
        setupUserQuestionsFilter();
    }else if (reportType === 'qa-log') {
        renderQALogTable();
        setupQALogFilters();
    }
}
function setupUserQuestionsFilter() {
    const filterSelect = document.getElementById('user-questions-status-filter');
    if (filterSelect) {
        filterSelect.addEventListener('change', () => {
            renderUserQuestionsTable();
        });
    }
}
function setupQALogFilters() {
    const userFilter = document.getElementById('qa-log-user-filter');
    const dateFromFilter = document.getElementById('qa-log-date-from');
    const dateToFilter = document.getElementById('qa-log-date-to');
    
    if (userFilter) {
        userFilter.addEventListener('change', filterQALog);
    }
    if (dateFromFilter) {
        dateFromFilter.addEventListener('change', filterQALog);
    }
    if (dateToFilter) {
        dateToFilter.addEventListener('change', filterQALog);
    }
}
        // Setup suggestions filter
        function setupSuggestionsFilter() {
            const filterSelect = document.getElementById('status-filter');
            if (filterSelect) {
                filterSelect.value = appState.suggestionsFilter;
                filterSelect.addEventListener('change', (e) => {
                    appState.suggestionsFilter = e.target.value;
                    appState.suggestionsPage = 1; // Reset to first page
                    renderSuggestionsTable();
                });
            }
        }
		

        // Render suggestions table
        function renderSuggestionsTable() {
			const tableBody = document.getElementById('suggestions-table-body');
			const emptyState = document.getElementById('suggestions-empty');
			const loadingState = document.getElementById('suggestions-loading');
			
			if (!tableBody) return;

			loadingState.style.display = 'block';
			emptyState.style.display = 'none';
			tableBody.innerHTML = '';

			let filteredSuggestions = appState.suggestions;
			if (appState.suggestionsFilter !== 'all') {
				filteredSuggestions = appState.suggestions.filter(s => s.status === appState.suggestionsFilter);
			}

			loadingState.style.display = 'none';

			if (filteredSuggestions.length === 0) {
				emptyState.style.display = 'block';
				return;
			}

			const startIndex = (appState.suggestionsPage - 1) * appState.suggestionsPerPage;
			const endIndex = startIndex + appState.suggestionsPerPage;
			const paginatedSuggestions = filteredSuggestions.slice(startIndex, endIndex);

			tableBody.innerHTML = paginatedSuggestions.map(suggestion => {
				const createdDate = new Date(suggestion.created_at).toLocaleDateString('en-US', {
					year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
				});

				const statusDropdown = `
					<select class="action-dropdown" onchange="updateSuggestionStatus(${suggestion.id}, this.value)">
						<option value="pending" ${suggestion.status === 'pending' ? 'selected' : ''}>Pending</option>
						<option value="resolved" ${suggestion.status === 'resolved' ? 'selected' : ''}>Resolved</option>
					</select>
				`;

				// --- NEW LOGIC FOR TRUNCATING THE ANSWER ---
				const answer = suggestion.answer || 'N/A';
				let answerCellHTML;
				const characterLimit = 100; // Set your desired character limit for truncation

				if (answer.length > characterLimit) {
					const truncatedAnswer = answer.substring(0, characterLimit);
					// We use JSON.stringify to safely pass the full answer string (with quotes, etc.) to the onclick function
					const escapedAnswer = JSON.stringify(answer); 
					answerCellHTML = `
						<div class="truncated-answer">${truncatedAnswer}</div>
						<a href="#" class="more-link" onclick='showFullAnswerModal(${escapedAnswer})'>...more</a>
					`;
				} else {
					answerCellHTML = answer;
				}
				// --- END OF NEW LOGIC ---

				return `
					<tr>
						<td style="max-width: 200px; word-wrap: break-word;">${suggestion.question || 'N/A'}</td>
						<td style="max-width: 200px;">${answerCellHTML}</td>
						<td style="max-width: 250px; word-wrap: break-word;">${suggestion.suggestion || 'N/A'}</td>
						<td>${suggestion.user_id || 'Anonymous'}</td>
						<td style="white-space: nowrap;">${createdDate}</td>
						<td style="text-align: center;">${statusDropdown}</td>
					</tr>
				`;
			}).join('');

			updateSuggestionsPagination(filteredSuggestions.length);
		}

        // Update pagination controls
        function updateSuggestionsPagination(totalSuggestions) {
            const paginationDiv = document.getElementById('suggestions-pagination');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            if (!paginationDiv || totalSuggestions <= appState.suggestionsPerPage) {
                paginationDiv.style.display = 'none';
                return;
            }

            paginationDiv.style.display = 'block';
            
            const totalPages = Math.ceil(totalSuggestions / appState.suggestionsPerPage);
            const currentPage = appState.suggestionsPage;
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        // Change page
        function changePage(direction) {
            const filteredSuggestions = appState.suggestionsFilter === 'all' 
                ? appState.suggestions 
                : appState.suggestions.filter(s => s.status === appState.suggestionsFilter);
                
            const totalPages = Math.ceil(filteredSuggestions.length / appState.suggestionsPerPage);
            
            const newPage = appState.suggestionsPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                appState.suggestionsPage = newPage;
                renderSuggestionsTable();
            }
        }

        // Resolve suggestion
        async function updateSuggestionStatus(suggestionId, newStatus) {
			try {
				const resolvedBy = 'admin'; // You may want to get this from the login state.
				const timestamp = new Date().toISOString();

				const { error } = await supabaseClient
					.from('suggestions')
					.update({
						status: newStatus,
						resolved_at: newStatus === 'resolved' ? timestamp : null,
						resolved_by: newStatus === 'resolved' ? resolvedBy : null,
						updated_at: timestamp
					})
					.eq('id', suggestionId);

				if (error) {
					console.error('Error updating suggestion status:', error);
					showTemporaryMessage('Error updating suggestion status: ' + error.message, 'error');
					return;
				}

				// Update the local state to match the database
				const suggestion = appState.suggestions.find(s => s.id === suggestionId);
				if (suggestion) {
					suggestion.status = newStatus;
					suggestion.resolved_at = newStatus === 'resolved' ? timestamp : null;
					suggestion.resolved_by = newStatus === 'resolved' ? resolvedBy : null;
					suggestion.updated_at = timestamp;
				}

				renderSuggestionsTable(); // Re-render the table to show the updated status
				showTemporaryMessage('Suggestion status updated successfully!', 'success');

			} catch (error) {
				console.error('Exception updating suggestion status:', error);
				showTemporaryMessage('An unexpected error occurred while updating the suggestion.', 'error');
			}
		}

        // Refresh suggestions
        async function refreshSuggestions() {
            const refreshBtn = document.querySelector('button[onclick="refreshSuggestions()"]');
            if (refreshBtn) {
                refreshBtn.textContent = 'Refreshing...';
                refreshBtn.disabled = true;
            }
            
            try {
                await loadSuggestions();
                renderSuggestionsTable();
                showTemporaryMessage('Suggestions refreshed successfully!', 'success');
            } catch (error) {
                console.error('Error refreshing suggestions:', error);
                showTemporaryMessage('Error refreshing suggestions', 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.textContent = 'Refresh';
                    refreshBtn.disabled = false;
                }
            }
        }

        // Show temporary message
        function showTemporaryMessage(message, type = 'info') {
            // Create or update message element
            let messageDiv = document.getElementById('temp-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'temp-message';
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 6px;
                    font-weight: 600;
                    z-index: 1001;
                    max-width: 300px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(messageDiv);
            }

            // Set message and color
            messageDiv.textContent = message;
            switch (type) {
                case 'success':
                    messageDiv.style.backgroundColor = '#d4edda';
                    messageDiv.style.color = '#155724';
                    messageDiv.style.border = '1px solid #c3e6cb';
                    break;
                case 'error':
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    break;
                default:
                    messageDiv.style.backgroundColor = '#d1ecf1';
                    messageDiv.style.color = '#0c5460';
                    messageDiv.style.border = '1px solid #bee5eb';
            }

            // Show and auto-hide
            messageDiv.style.display = 'block';
            setTimeout(() => {
                if (messageDiv) {
                    messageDiv.style.display = 'none';
                }
            }, 3000);
        }
		// Update current admin display
        function updateCurrentAdminDisplay() {
            const displayElement = document.getElementById('current-admin-display');
            if (displayElement) {
                const currentUser = appState.currentAdminUser || 'Unknown';
                displayElement.textContent = currentUser;
            }
        }
		// Show pages
        function showUserPage(userName) {
    // NEW: ensure current user is set as soon as we enter the user page
    if (!appState.currentUser) appState.currentUser = userName;

    document.querySelector('.header').style.display = 'flex';
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('admin-page').style.display = 'none';
    document.getElementById('user-page').classList.remove('hidden');
    document.getElementById('user-header-buttons').style.display = 'flex';
    document.getElementById('admin-header-buttons').style.display = 'none';

    document.getElementById('user-name').textContent = userName;
    clearUserForm();
}


        function showAdminPage() {
    // NEW: ensure a current user value exists for admin context too
    if (!appState.currentUser) appState.currentUser = (appState.currentAdminUser || 'admin');

    document.querySelector('.header').style.display = 'flex';
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('user-page').classList.add('hidden');
    document.getElementById('admin-page').style.display = 'block';
    document.getElementById('admin-header-buttons').style.display = 'flex';
    document.getElementById('user-header-buttons').style.display = 'none';
    document.getElementById('chatbot-container').style.display = 'block';

    // keep your existing highlights:
    showSection('qa');
    setMode('ask');
}


        // User question handling
        function handleUserQuestionInput() {
            const input = document.getElementById('user-question').value.trim();
            const predictionContainer = document.getElementById('user-prediction-list');
            
            if (input.length < 3) {
                if (predictionContainer) predictionContainer.style.display = 'none';
                return;
            }
            
            const predictions = findUserSimilarQuestions(input);
            displayUserPredictions(predictions);
        }

        // --- NLP-Enhanced Prediction Logic ---
        const stopWords = new Set(['a', 'an', 'the', 'is', 'in', 'on', 'at', 'for', 'to', 'of', 'how', 'what', 'when', 'where', 'why', 'do', 'and', 'or', 'but']);

        function simpleStem(word) {
            const endings = ['s', 'es', 'ed', 'ing', 'er', 'est'];
            for (const ending of endings) {
                if (word.endsWith(ending)) {
                    return word.slice(0, -ending.length);
                }
            }
            return word;
        }

        function tokenize(text) {
            return text.toLowerCase().match(/\b\w+\b/g) || [];
        }

        function preprocess(text) {
            const tokens = tokenize(text);
            const processedTokens = tokens
                .map(simpleStem)
                .filter(token => !stopWords.has(token));
            return new Set(processedTokens);
        }

        function createNgrams(text, n) {
            const words = tokenize(text).filter(token => !stopWords.has(token));
            const ngrams = new Set();
            for (let i = 0; i <= words.length - n; i++) {
                ngrams.add(words.slice(i, i + n).join(' '));
            }
            return ngrams;
        }
        
        let termFrequencies = {};

        function precomputeTermFrequencies() {
            termFrequencies = {};
            const allDocs = appState.qaData.filter(qa => qa.question);
            if (allDocs.length === 0) return;

            allDocs.forEach(doc => {
                const tokens = preprocess(doc.question);
                tokens.forEach(token => {
                    termFrequencies[token] = (termFrequencies[token] || 0) + 1;
                });
            });
        }

        function findUserSimilarQuestions(input) {
            if (Object.keys(termFrequencies).length === 0) {
                precomputeTermFrequencies();
            }

            const inputTokens = preprocess(input);
            const inputBigrams = createNgrams(input, 2);
            
            const scoredQuestions = appState.qaData.map(qa => {
                if (!qa.question || !hasUserAccess(qa.departments)) {
                    return { ...qa, score: 0 };
                }

                let score = 0;
                const qaTokens = preprocess(qa.question);
                const qaBigrams = createNgrams(qa.question, 2);

                // TF-IDF inspired keyword scoring
                inputTokens.forEach(token => {
                    if (qaTokens.has(token)) {
                        const idf = Math.log((appState.qaData.length + 1) / (termFrequencies[token] || 1));
                        score += 10 * idf; // Give more weight to rarer, matching words
                    }
                });
                
                // N-gram (bigram) scoring
                inputBigrams.forEach(bigram => {
                    if (qaBigrams.has(bigram)) {
                        score += 25; // High score for matching phrases
                    }
                });
                
                // Full substring match bonus
                if (qa.question.toLowerCase().includes(input.toLowerCase())) {
                    score += 10;
                }

                // Brevity bonus
                if (qa.question.length < 100) {
                    score += 5;
                }

                return { ...qa, score };
            });

            return scoredQuestions
                .filter(qa => qa.score > 10) // Set a higher threshold for relevance
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
        }

        function hasUserAccess(questionDepartments) {
            if (!questionDepartments || questionDepartments === 'all') return true;
            
            const currentUser = appState.users.find(u => u.user_id === appState.currentUser);
            if (!currentUser || !currentUser.department) return false;
            
            const userDepartments = currentUser.department.split(',').map(d => d.trim());
            const qaDeparts = questionDepartments.split(',').map(d => d.trim());
            
            return qaDeparts.some(dept => userDepartments.includes(dept));
        }

        function displayUserPredictions(predictions) {
            const container = document.getElementById('user-prediction-list');
            if (!container) return;
            
            if (predictions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = predictions.map(p => `
                <div class="user-prediction-item" onclick="selectUserPrediction('${p.id}')">
                    ${p.question}
                </div>
            `).join('');
            container.style.display = 'block';
        }

        function selectUserPrediction(predictionId) {
            const prediction = appState.qaData.find(qa => qa.id == predictionId);
            if (!prediction) return;
            
            const questionField = document.getElementById('user-question');
            const answerField = document.getElementById('user-answer');
            const predictionList = document.getElementById('user-prediction-list');
            
            questionField.value = prediction.question;
            answerField.value = prediction.answer || '';
            
            appState.currentQA = prediction;
            showUserMediaButtons(prediction);
            showSuggestionSection();
            
            if (predictionList) predictionList.style.display = 'none';
        }

        
    
   async function handleUserSubmit() {
    const questionText = document.getElementById('user-question').value.trim();
    const answerField = document.getElementById('user-answer');
    
    if (!questionText) {
        alert('Please enter a question');
        return;
    }
    
    if (!appState.currentUser) {
        alert('You must be logged in to submit questions');
        return;
    }
    
    console.log('User submitted question:', questionText);
    console.log('Current user:', appState.currentUser);
    
    let foundAnswer = '';
    let qaId = null;
    let searchResult = 'no_answer';
    
    try {
        // Find exact or similar match
        const exactMatch = appState.qaData.find(qa => 
            qa.question && 
            qa.question.toLowerCase() === questionText.toLowerCase() &&
            hasUserAccess(qa.departments)
        );
        
        if (exactMatch) {
            foundAnswer = exactMatch.answer || 'No answer available';
            qaId = exactMatch.id;
            searchResult = 'exact_match';
            answerField.value = foundAnswer;
            appState.currentQA = exactMatch;
            showUserMediaButtons(exactMatch);
            showSuggestionSection();
            console.log('Found exact match:', exactMatch.id);
        } else {
            const similarQuestions = findUserSimilarQuestions(questionText);
            if (similarQuestions.length > 0) {
                const bestMatch = similarQuestions[0];
                foundAnswer = bestMatch.answer || 'No answer available';
                qaId = bestMatch.id;
                searchResult = 'similar_match';
                answerField.value = foundAnswer;
                appState.currentQA = bestMatch;
                showUserMediaButtons(bestMatch);
                showSuggestionSection();
                console.log('Found similar match:', bestMatch.id);
            } else {
                foundAnswer = 'Sorry, I could not find an answer to your question. Please contact support or try rephrasing your question.';
                searchResult = 'no_answer';
                answerField.value = foundAnswer;
                appState.currentQA = null;
                hideUserMediaButtons();
                hideSuggestionSection();
                console.log('No match found');
            }
        }
        
        // Log the search to database
        console.log('About to log search...');
        const logSuccess = await logUserSearch(questionText, foundAnswer, qaId, searchResult);
        console.log('Search logging result:', logSuccess);
        
    } catch (error) {
        console.error('Error in handleUserSubmit:', error);
        alert('An error occurred while processing your question. Please try again.');
    }
}
// Fixed function to log user searches
async function logUserSearch(questionSearched, answerFound, qaId, searchResult) {
    if (!appState.currentUser) {
        console.error('No current user, cannot log search');
        return false;
    }
    
    if (!supabaseClient) {
        console.error('Supabase client not initialized');
        return false;
    }
    
    try {
        console.log('Logging search with data:', {
            user_id: appState.currentUser,
            question_searched: questionSearched,
            search_result: searchResult,
            qa_id: qaId
        });
        
        const logEntry = {
            user_id: appState.currentUser,
            question_searched: questionSearched,
            answer_found: answerFound || null,
           
            search_time: new Date().toISOString(),
            result: searchResult || 'no_answer'
        };
        
        const { data, error } = await supabaseClient
            .from('qa_log')
            .insert([logEntry])
            .select();
        
        if (error) {
            console.error('Database error logging search:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            return false;
        }
        
        console.log('Search logged successfully:', data);
        return true;
        
    } catch (error) {
        console.error('Exception in logUserSearch:', error);
        return false;
    }
}
// --- Add once, near the top of your JS ---
// --- session tracking init (optional) ---
function initSessionTracking() {
  if (!localStorage.getItem('session_id')) {
    const sid = (crypto?.randomUUID?.() || (Date.now().toString(36) + Math.random().toString(36).slice(2)));
    localStorage.setItem('session_id', sid);
  }
  appState.sessionId = localStorage.getItem('session_id') || null;
  appState.userAgent = navigator.userAgent || null;

  // Public IP fetch (ok if it fails)
  fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(j => appState.ipAddress = j?.ip || null)
    .catch(() => appState.ipAddress = null);
}

document.addEventListener('DOMContentLoaded', initSessionTracking);


// Generate a simple session ID
function generateSessionId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}
        function showUserMediaButtons(qaItem) {
            const mediaButtons = document.getElementById('user-media-buttons');
            const videoBtn = document.getElementById('user-video-btn');
            const imageBtn = document.getElementById('user-image-btn');
            
            if (!getSetting('allow_media_visibility', true)) {
                mediaButtons.style.display = 'none';
                return;
            }
            
            let hasMedia = false;
            
            if (qaItem && qaItem.video_url && qaItem.video_url.trim()) {
                videoBtn.disabled = false;
                videoBtn.style.opacity = '1';
                hasMedia = true;
            } else {
                videoBtn.disabled = true;
                videoBtn.style.opacity = '0.5';
            }
            
            if (qaItem && qaItem.image_urls && qaItem.image_urls.trim()) {
                imageBtn.disabled = false;
                imageBtn.style.opacity = '1';
                hasMedia = true;
            } else {
                imageBtn.disabled = true;
                imageBtn.style.opacity = '0.5';
            }
            
            mediaButtons.style.display = hasMedia ? 'flex' : 'none';
        }

        function hideUserMediaButtons() {
            const mediaButtons = document.getElementById('user-media-buttons');
            mediaButtons.style.display = 'none';
        }

        function showSuggestionSection() {
            const suggestionSection = document.getElementById('suggestion-section');
            if (getSetting('allow_suggestions', true) && appState.currentQA) {
                suggestionSection.style.display = 'block';
            } else {
                suggestionSection.style.display = 'none';
            }
        }

        function hideSuggestionSection() {
            const suggestionSection = document.getElementById('suggestion-section');
            suggestionSection.style.display = 'none';
        }

        function showUserVideo() {
            if (!appState.currentQA || !appState.currentQA.video_url) {
                alert('No video available for this question');
                return;
            }
            
            const modal = document.getElementById('media-modal');
            const modalBody = document.getElementById('media-modal-body');
            
            const videoUrl = appState.currentQA.video_url.trim();
            
            let videoContent;
            if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                let videoId = '';
                if (videoUrl.includes('youtube.com/watch?v=')) {
                    videoId = videoUrl.split('v=')[1].split('&')[0];
                } else if (videoUrl.includes('youtu.be/')) {
                    videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                }
                
                if (videoId) {
                    videoContent = `
                        <iframe 
                            width="800" 
                            height="450" 
                            src="https://www.youtube.com/embed/${videoId}" 
                            frameborder="0" 
                            allowfullscreen>
                        </iframe>
                    `;
                } else {
                    videoContent = `<p>Invalid YouTube URL</p>`;
                }
            } else {
                videoContent = `
                    <video controls width="800" height="450">
                        <source src="${videoUrl}" type="video/mp4">
                        <source src="${videoUrl}" type="video/webm">
                        <source src="${videoUrl}" type="video/ogg">
                        Your browser does not support the video tag.
                        <p><a href="${videoUrl}" target="_blank">Open video in new tab</a></p>
                    </video>
                `;
            }
            
            modalBody.innerHTML = `
                <h3 style="margin-bottom: 20px;">Video for: ${appState.currentQA.question}</h3>
                ${videoContent}
            `;
            
            modal.style.display = 'flex';
        }

        function showUserImages() {
            if (!appState.currentQA || !appState.currentQA.image_urls) {
                alert('No images available for this question');
                return;
            }
            
            const modal = document.getElementById('media-modal');
            const modalBody = document.getElementById('media-modal-body');
            
            const imageUrls = appState.currentQA.image_urls.split(',').map(url => url.trim()).filter(Boolean);
            
            if (imageUrls.length === 0) {
                alert('No valid images found');
                return;
            }
            
            const imageContent = imageUrls.map(url => {
                const isPdf = url.toLowerCase().endsWith('.pdf');
                const fullUrl = url.startsWith('http') ? url : url;
                
                if (isPdf) {
                    return `
                        <div style="margin-bottom: 20px;">
                            <h4>PDF Document</h4>
                            <iframe src="${fullUrl}" width="100%" height="600" style="border: 1px solid #ddd;"></iframe>
                            <p><a href="${fullUrl}" target="_blank">Open PDF in new tab</a></p>
                        </div>
                    `;
                } else {
                    return `
                        <div style="margin-bottom: 20px; text-align: center;">
                            <img src="${fullUrl}" alt="Image" style="max-width: 100%; max-height: 600px; border: 1px solid #ddd; border-radius: 8px;">
                            <p><a href="${fullUrl}" target="_blank">Open image in new tab</a></p>
                        </div>
                    `;
                }
            }).join('');
            
            modalBody.innerHTML = `
                <h3 style="margin-bottom: 20px;">Images for: ${appState.currentQA.question}</h3>
                <div style="max-height: 70vh; overflow-y: auto;">
                    ${imageContent}
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeMediaModal() {
            const modal = document.getElementById('media-modal');
            modal.style.display = 'none';
        }

        async function submitSuggestion() {
            const suggestionText = document.getElementById('suggestion-text').value.trim();
            
            if (!suggestionText) {
                alert('Please enter a suggestion');
                return;
            }
            
            if (!appState.currentQA) {
                alert('No question selected for suggestion');
                return;
            }
            
            try {
                const suggestion = {
                    question: appState.currentQA.question,
                    answer: appState.currentQA.answer,
                    suggestion: suggestionText,
                    user_id: appState.currentUser,
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('suggestions')
                    .insert([suggestion]);
                
                if (error) {
                    console.error('Error submitting suggestion:', error);
                    alert('Error submitting suggestion: ' + error.message);
                    return;
                }
                
                document.getElementById('suggestion-text').value = '';
                alert('Thank you! Your suggestion has been submitted successfully.');
                
            } catch (error) {
                console.error('Exception submitting suggestion:', error);
                alert('An unexpected error occurred while submitting your suggestion.');
            }
        }

        function clearUserForm() {
            const questionField = document.getElementById('user-question');
            const answerField = document.getElementById('user-answer');
            const suggestionField = document.getElementById('suggestion-text');
            
            if (questionField) questionField.value = '';
            if (answerField) answerField.value = '';
            if (suggestionField) suggestionField.value = '';
            
            hideUserMediaButtons();
            hideSuggestionSection();
            
            appState.currentQA = null;
        }
		
		function formatTimestamp(timestamp) {
			if (!timestamp) return 'N/A';
			const date = new Date(timestamp);
			// Check if the date is valid before formatting
			if (isNaN(date.getTime())) {
				return 'N/A';
			}
			return date.toLocaleDateString('en-US', {
				year: 'numeric', month: 'short', day: 'numeric', 
				hour: '2-digit', minute: '2-digit'
			});
		}
		
		
// Add these new helper functions to your script
function togglePasswordReqs(show) {
    const collapsible = document.getElementById('password-reqs-collapsible');
    const arrow = document.getElementById('password-reqs-arrow');
    if (!collapsible || !arrow) return;

    if (show) {
        collapsible.style.display = 'block';
        arrow.classList.add('expanded');
    } else {
        collapsible.style.display = 'none';
        arrow.classList.remove('expanded');
    }
}

function updatePasswordRequirementsUI() {
    const requirementsDiv = document.getElementById('password-requirements');
    if (!requirementsDiv) return;

    const settings = appState.settings || {};

    if (settings.enforce_password_requirements === false) {
        requirementsDiv.style.display = 'none';
        return;
    }

    requirementsDiv.style.display = 'block';

    const reqLength = document.getElementById('req-length');
    const reqUppercase = document.getElementById('req-uppercase');
    const reqLowercase = document.getElementById('req-lowercase');
    const reqNumber = document.getElementById('req-number');
    const reqSpecial = document.getElementById('req-special');

    if (reqLength) {
        reqLength.style.display = settings.enforce_pw_min_length ? 'list-item' : 'none';
        const span = reqLength.querySelector('span') || reqLength;
        span.textContent = `At least ${settings.pw_min_length_value || 8} characters long`;
    }
    if (reqUppercase) reqUppercase.style.display = settings.enforce_pw_uppercase ? 'list-item' : 'none';
    if (reqLowercase) reqLowercase.style.display = settings.enforce_pw_lowercase ? 'list-item' : 'none';
    if (reqNumber) reqNumber.style.display = settings.enforce_pw_number ? 'list-item' : 'none';
    if (reqSpecial) reqSpecial.style.display = settings.enforce_pw_special ? 'list-item' : 'none';
}
// Missing sendMessage function - this handles the send button and enter key
function sendMessage() {
    const chatInput = document.getElementById('chat-input');
    const question = chatInput.value.trim();
    if (!question) return;

    appendMessage(question, 'user');
    chatInput.value = '';

    // Use the global variable updated by showSection()
    sendToN8N(question, currentAdminSection);
}

// Enhanced chatbot functionality with website context
async function sendToN8N(question, context) {
    const n8nWebhookURL = 'https://ahsanaah29.app.n8n.cloud/webhook/chatbot';

    // Show typing indicator
    const typingMessage = appendMessage('TallyQueryMate is thinking...', 'bot');
    const chatBody = document.getElementById('chat-body');

    try {
        // Prepare payload with enhanced context
        const payload = {
            question: question,
            pageContext: context,
            timestamp: new Date().toISOString(),
            userId: appState.currentUser || appState.currentAdminUser || 'anonymous',
            userType: appState.currentUserType || 'unknown'
        };

        console.log('Sending to n8n:', payload);

        const response = await fetch(n8nWebhookURL, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Received from n8n:', data);

        const botAnswer = data.answer || "Sorry, I couldn't process your question.";

        // Remove typing indicator
        if (typingMessage && typingMessage.parentNode) {
            typingMessage.parentNode.removeChild(typingMessage);
        }

        // Add the actual response
        appendMessage(botAnswer, 'bot');

        // Log this interaction for analytics (optional)
        logChatbotInteraction(question, botAnswer, context);

    } catch (error) {
        console.error('Error calling n8n webhook:', error);
        
        // Remove typing indicator
        if (typingMessage && typingMessage.parentNode) {
            typingMessage.parentNode.removeChild(typingMessage);
        }
        
        // Show error message
        appendMessage("I'm having trouble connecting right now. Please try again in a moment.", 'bot');
    }
}

// Enhanced message appending with better UX
function appendMessage(message, type) {
    const chatBody = document.getElementById('chat-body');
    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message', type);
    
    if (type === 'bot' && message.includes('thinking')) {
        messageElement.classList.add('typing');
        messageElement.innerHTML = `
            <span class="typing-dots">
                <span></span><span></span><span></span>
            </span>
            ${message}
        `;
    } else {
        messageElement.textContent = message;
    }
    
    chatBody.appendChild(messageElement);
    chatBody.scrollTop = chatBody.scrollHeight;
    
    return messageElement; // Return reference for removal
}

// Optional: Log chatbot interactions for analytics
async function logChatbotInteraction(question, answer, context) {
    if (!supabaseClient) return;
    
    try {
        await supabaseClient
            .from('chatbot_logs')
            .insert([{
                user_id: appState.currentUser || appState.currentAdminUser || 'anonymous',
                question: question,
                answer: answer,
                page_context: context,
                timestamp: new Date().toISOString()
            }]);
    } catch (error) {
        console.log('Could not log chatbot interaction:', error);
        // Don't alert user - this is optional logging
    }
}

// Enhanced chatbot setup with better error handling
function setupChatbotListeners() {
    const chatBubble = document.getElementById('chatbot-bubble');
    const chatWindow = document.getElementById('chatbot-window');
    const closeChatBtn = document.getElementById('close-chat-btn');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');

    if (!chatBubble || !chatWindow) {
        console.error("Chatbot elements not found!");
        return;
    }

    chatBubble.addEventListener('click', () => {
        chatWindow.classList.toggle('hidden');
        // Focus on input when opening
        if (!chatWindow.classList.contains('hidden')) {
            setTimeout(() => chatInput.focus(), 100);
        }
    });

    closeChatBtn.addEventListener('click', () => {
        chatWindow.classList.add('hidden');
    });

    sendChatBtn.addEventListener('click', sendMessage);
    
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Remove the duplicate welcome message - your HTML already has one
}
    </script>
<div id="chatbot-container" style="display: none;">
    <div id="chatbot-window" class="hidden">
        <div class="chat-header">
            TallyQueryMate
            <button id="close-chat-btn">&times;</button>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="chat-message bot">Hello! How can I help you with the admin page today?</div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chat-input" placeholder="Ask a question...">
            <button id="send-chat-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
   <button id="chatbot-bubble">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M21.83,11.35,19.2,2.45a2.49,2.49,0,0,0-2.3-1.8H7.1a2.49,2.49,0,0,0-2.3,1.8L2.17,11.35a2.5,2.5,0,0,0,0,2.3l2.63,8.9a2.49,2.49,0,0,0,2.3,1.8h9.8a2.49,2.49,0,0,0,2.3-1.8l2.63-8.9A2.5,2.5,0,0,0,21.83,11.35ZM12,17.25a.75.75,0,1,1,.75-.75A.75.75,0,0,1,12,17.25Zm-3,0a.75.75,0,1,1,.75-.75A.75.75,0,0,1,9,17.25Zm6,0a.75.75,0,1,1,.75-.75A.75.75,0,0,1,15,17.25Z" />
    </svg>
</button>
</div>

</body>
</html>
